{{ header }}
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<div id="vue-order-app">
<!-- Modal cost -->
	<div class="modal fade" id="orderCostModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog modal-lg" role="document">

				<div class="modal-content">
					<div class="modal-header">
					<h4 class="modal-title" id="myModalLabel">Inköpskostnader</h4>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<order-detail-costs
							inline-template
						>
							<div>
								<form ref="form" method="POST">
									<div class="row">
										<div class="col-sm-12">
											<h5 class="modal-title">Lägg till kostnad</h5><br>
										</div>
										<div class="col-sm-6">
											<select class="form-select" v-model="supplier" required>
												<option value="">Välj leverantör</option>
												<option v-for="supplier in all_suppliers" :value="supplier.name">${ supplier.name }</option>
											</select>
										</div>
										<div class="col-sm-6">
											<select class="form-select" v-model="type" required>
												<option value="">Typ</option>
												<option value="Garment">Kläder</option>
												<option value="Print">Tryck</option>
												<option value="Shipping">Frakt</option>
												<option value="Waste">Waste</option>
												<option value="Extra">Övrigt</option>
											</select>
										</div>
									</div>
									<div class="row">
										<div class="col-sm-6" style="margin-top:10px">
											<input type="text" class="form-control" v-model="label" placeholder="Beskrivning/Label"/>
										</div>
										<div class="col-sm-6" style="margin-top:10px; display:flex;">
											{# <input type="number" class="form-control"  placeholder="Inköpskostnad" v-model.number="cost" step="0.01" required style="width: 90%"/>
											<button class="btn btn-outline-secondary" :disabled="processing" @click="savePurchaseCost"><i class="fa fa-check"></i> Spara</button> #}
												<input type="number" class="form-control" placeholder="Inköpskostnad" v-model.number="cost" step="0.01" required style="width:74%"/>
												<button class="btn btn-outline-secondary mx-2" :disabled="processing" @click="savePurchaseCost" type="button" ><i class="fa fa-check"></i> Spara</button>
										</div>
									</div>

								</form>
								<div class="clearfix"></div>
								<hr>
								<div>
									<ul class="order-cost-list">
										<li style="border-bottom:1px solid #8a9096;padding:8px 2px;" v-for="(item, index) in costs_list">
										<i class="fa fa-check-square"></i> <span class="order-cost-supplier" v-html="item.supplier"></span>
										<span v-if="item.label.length > 0" v-html="item.label" class="order-cost-supplier"></span>
										<span v-html="item.type" style="margin-left:10px;"></span>
										- ${ item.cost } kr
										<button style="float:right;" class="btn btn-link btn-sm" @click="removeCost(item, index)"><i class="fa fa-trash"></i></button></li>
									</ul>
								</div>
							</div>
						</order-detail-costs>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stäng</button>
					</div>
				</div>

		</div>
	</div>
	 <!-- Modal cost -->
</div>
{{ column_left }}
<div id="content">
	<!-- B2Bmanager Module-->
	 <script src="view/javascript/RowSorter.js" type="text/javascript"></script>
		<style>
			#container {
				background: #fff;
			}
            .dropdown:hover>.dropdown-menu {
				display: block;
			}

			.dropdown>.dropdown-toggle:active {
			/*Without this, clicking will make it sticky*/
				pointer-events: none;
			}
			.order-cost-list {
				list-style: none;
				margin: 0;
				padding: 0;
				margin-left: 10px;
				width: 100%;
			}
		</style>
		<div id="result"> </div>
	<form method="post" enctype="multipart/form-data" id="form-product">
		<div class="page-header" style="border:none;">
			<div class="container-fluid">
				<div class="float-end">
					<button type="button" class="btn btn-warning" id="shipping_label" data-toggle="modal" data-target="#shippingModal"><i class="fa fa-th-list"></i> Fraktsedel</button>
					<button type="button" class="btn btn-secondary" id="create_invoice" data-toggle="modal" data-target="#invoiceModal"><i class="fa fa-file-text"></i> Skapa faktura</button>
					<button type="button" id="order_cost" data-toggle="modal" data-target="#orderCostModal" class="btn btn-primary"><i class="fa fa-dollar-sign"></i> Kostnader</button>
                    <a class="btn btn-info" href="{{link_receipt}}" target="_blank" >Kvitto</a>
                    <a class="btn btn-info" href="{{link_delivery_note}}" target="_blank" >Följesedel</a>
					<a class="btn btn-success" data-toggle="tooltip" id="button-save" onclick="saveOrder();" title="{{ button_save }}"><i class="fa fa-save"></i> Spara</a>
				</div>
				<h1>
					<span class="label-order">Order {% if order_id %} #{{order_id}}{% endif %}</span>
				</h1>
				<hr>
			</div>
		</div>
		<input type="hidden" name="buttontype" id="buttontype" value="">
		<div class="container-fluid codevoc-b2b">
			<div class="row mb-3">
				<div class="col-sm-3">
					<select class="form-select" name="shipping_method" id="input-shipping-method">
						<option value="" cost="0" tax="0" total="0">--{{ entry_shipping_method }}--</option>
						{% for method in shipping_methods %}
							{% if method.installed == 1 and method.status == 'Enabled' %}
								{% if shipping_method == method.code  %}
								{% set code = method.code %}
									<option value="{{ method.code }}" cost="{{method.cost}}" tax="{{method.tax_rate}}" total="{{method.total_cost}}" selected="selected">{{ method.name }}</option>
								{% else %}
									<option value="{{ method.code }}" cost="{{method.cost}}" tax="{{method.tax_rate}}" total="{{method.total_cost}}">{{ method.name }}</option>
								{% endif %}
							{% endif %}
						{% endfor %}
					</select>
				</div>
				<div class="col-sm-3">
					<select class="form-select" name="payment_method" id="input-payment-method">
						<option value="">--{{entry_payment_method}}--</option>
						{% for method in payment_methods %}
							{% if method.installed == 1%}
								{% if payment_method == method.code %}
									<option value="{{ method.code }}" selected="selected">{{ method.name }}</option>
								{% else %}
									<option value="{{ method.code }}">{{ method.name }}</option>
								{% endif %}
							{% endif %}
						{% endfor %}
					</select>
				</div>
				<div class="col-sm-3">
					<select class="form-select" id="assignee" name="assignee">
						<option value="" selected="selected">{{ text_select }}</option>
						{% for system_user in system_users %}
							{% if system_user.user_id == codevocb2border.assignee %}
								<option value="{{system_user.user_id}}" selected="selected">{{system_user.username}}</option>
							{% else %}
								<option value="{{system_user.user_id}}">{{system_user.username}}</option>
							{% endif %}
						{% endfor %}
					</select>
				</div>
				<div class="col-sm-3">
					<select class="form-select" id="order_status_id" name="order_status_id">
						<option value="" selected="selected">{{ text_select }}</option>
						{% for order_status in order_statuses %}
							{% if order_status.order_status_id == order_status_id %}
								<option value="{{ order_status.order_status_id }}" selected="selected">{{ order_status.name }}</option>
							{% else %}
								<option value="{{ order_status.order_status_id }}">{{ order_status.name }}</option>
							{% endif %}
						{% endfor %}
					</select>
				</div>
				<div class="clearfix"></div>
			</div>
            <hr>
            <div class="mb-3" style="padding: 15px 0px 15px 0px; border-radius: 6px; border: 6px black;">
                <span style="padding: 10px 20px 10px 10px; background: lightgray;border-radius: 10px 0px 0px 10px;"><i class="fa fa-user"></i> Customer</span>
                {% if customer %}<span class="customer-span border border-lightgray">{{ firstname }} {{ lastname }} <i class="btn btn-sm fa fa-copy copy-button" data-bs-toggle="tooltip" data-bs-title="Copy to clipboard" style="color:grey" data-copyname="{{firstname}} {{lastname}}"></i></span>{% endif %}
                {% if codevocb2border.vatnr %}<span class="customer-span border border-lightgray">{{ codevocb2border.vatnr }} <i class="btn btn-sm fa fa-copy copy-button" data-bs-toggle="tooltip" data-bs-title="Copy to clipboard" style="color:grey" data-copyname="{{ codevocb2border.vatnr }}"></i></span>{% endif %}
                {% if telephone %}<span class="customer-span border border-lightgray"><i class="fa fa-phone"></i> {{telephone}} <i class="btn btn-sm fa fa-copy copy-button" data-bs-toggle="tooltip" data-bs-title="Copy to clipboard" style="color:grey" data-copyname="{{telephone}}"></i></span>{% endif %}
                {% if email %}<span class="customer-span border border-lightgray"><i class="fa fa-envelope"></i> {{email}} <i class="btn btn-sm fa fa-copy copy-button" data-bs-toggle="tooltip" data-bs-title="Copy to clipboard" style="color:grey" data-copyname="{{email}}"></i></span>{% endif %}
                {# {% if customer %}<span class="customer-span border border-lightgray">{{ firstname }} {{ lastname }}</span>{% endif %} #}
            </div>
            <div class="row mb-3">
                <div class="col-sm-3">
                    <div class="card" style="">
                        <div class="card-header" style="padding: 14px;">
                            <b>Order</b>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">Order nr: <span class="float-end">{{order_id}}</span></li>
                            <li class="list-group-item">Skapad: <span class="float-end">{{date_added}}</span></li>
                            <li class="list-group-item">Tilldelad: <span class="float-end">{{order_assignee.username}}</span></li>
                            <li class="list-group-item">Typ: <span class="float-end">
							<select class="form-select-sm" id="orderType">
							{% if order_type == 'Quotation' %}
								<option value="printed" selected="selected"> Printed</option>
								<option value="plain"> Oprofilerad</option>
							{% else %}
								<option value="printed"> Profilerad</option>
								<option value="plain" selected="selected"> Plain</option>
							{% endif %}
							</select>
							</span>
							</li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-3">
                    {% if quotation_id != '' %}
                        <div class="card" style="height: 100%">
                            <div class="card-header">
                                <b>Offert</b>
                                <span class="float-end"><a href="{{button_quotation}}" class="btn btn-sm btn-primary">Öppna <i class="fa-solid fa-play"></i></a></span>
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">Offertnr: <span class="float-end">{{quotation_id}}</span></li>
                                <li class="list-group-item">Skapad: <span class="float-end">{{quotation_date}}</span></li>
                                <li class="list-group-item">Tilldelad: <span class="float-end">{{quotation_assignee.username}}</span></li>
                                {# <li class="list-group-item"> </li> #}
                            </ul>
                        </div>
                        {% else %}
                        <div class="card" style="height: 100%">
                            <div class="card-header">
                                <b>Offert</b>
                                {# <span class="float-end"><a href="{{button_quotation}}" class="btn btn-sm btn-primary">OPEN <i class="fa-solid fa-play"></i></a></span> #}
                            </div>
                            <div class="card-body">
                                <div class="align-middle">Ingen offert kopplad.</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="col-sm-3">
                    {% if productions.production_id != '' %}
                        <div class="card" style="height: 100%">
                            <div class="card-header">
                                <b>Produktion</b>
                                <span class="float-end"><a href="{{productions.productionurl}}" class="btn btn-sm btn-primary">Öppna <i class="fa-solid fa-play"></i></a></span>
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">Produktionsnr: <span class="float-end">{{productions.production_id}}</span></li>
                                <li class="list-group-item">Skapad: <span class="float-end">{{productions.date_created}}</span></li>
                                <li class="list-group-item">Produceras: <span class="float-end">{{productions.due_date}}</span></li>
                                {# <li class="list-group-item"> </li> #}
                            </ul>
                        </div>
                        {% else %}
                        <div class="card" style="height: 100%">
                            <div class="card-header">
                                <b>Produktion</b>
                                {# <span class="float-end"><a href="{{productions.productionurl}}" class="btn btn-sm btn-primary">OPEN <i class="fa-solid fa-play"></i></a></span> #}
                            </div>
                            <div class="card-body">
								{% for custom_field in custom_fields %}
									{% if custom_field.location == 'account' %}
										{% if custom_field.name == 'Företag' %}
											{% set thisCompanyName = account_custom_field[custom_field.custom_field_id] ? account_custom_field[custom_field.custom_field_id] : custom_field.value %}
											<div class="align-middle">
												 Ingen produktion skapad.
												<span class="float-end"><a class="btn btn-sm btn-outline-primary" data-toggle="tooltip" data-placement="top" title="Add production" href="{{addproductions}}&companyname={{ thisCompanyName }}" target="_blank"><i class="fa fa-plus"></i></a></span>
											</div>
										{% endif %}
									{% endif %}
								{% endfor %}
							</div>
                        </div>
                    {% endif %}
                </div>
                <div class="col-sm-3">
                    {% if purchase.purchase_id != '' %}
                        <div class="card" style="height: 100%">
                            <div class="card-header">
                                <b>Inköp</b>
                                <span class="float-end"><a href="{{purchase.purchase_url}}" class="btn btn-sm btn-primary">Öppna <i class="fa-solid fa-play"></i></a></span>
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">Inköpsnr: <span class="float-end">{{ purchase.purchase_id }}</span></li>
                                <li class="list-group-item">Skapad: <span class="float-end">{{purchase.create_date}}</span></li>
                                <li class="list-group-item">Kostnad: <span class="float-end">{{purchase.cost}}</span></li>
                                <li class="list-group-item">Leverantör: <span class="float-end">{{ purchase.vendor }}</span></li>
                            </ul>
                        </div>
                        {% else %}
                        <div class="card" style="height: 100%">
                            <div class="card-header">
                                <b>Inköp</b>
                                {# <span class="float-end"><a href="{{purchase.purchase_url}}" class="btn btn-sm btn-primary">OPEN <i class="fa-solid fa-play"></i></a></span> #}
                            </div>
                            <div class="card-body">
                                <div class="align-middle">Inga inköp kopplade.</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
			<div class="row mb-3">
				<div class="col-sm-12">

					<div class="clearfix h10"></div>
					<div class="accordion" id="accordionQuotationAdd" role="tablist" aria-multiselectable="true">
						<div class="accordion-item">
							<h2 class="accordion-header" id="heading-account-details">
								<button class="accordion-button" type="button" id="accountdetails" data-bs-toggle="collapse" data-bs-target="#account-details" aria-expanded="true" aria-controls="account-details">
									<i class="fa fa-user"></i>&nbsp;{{tab_client_detail}}
								</button>
							</h2>
							<div id="account-details" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionQuotationAdd">
								<div class="accordion-body">
									<div class="row">
										<div class="col-sm-8">
											<label>{{entry_customer}}</label>
											<div class="input-group mb-3">
												<span class="input-group-text">
													<a href="{{customerurl}}" target="_blank">
														<i class="fa fa-address-book"></i>
													</a>
												</span>
												<input type="text" class="form-control" name="customer" value="{{ customer }}" placeholder="{{ entry_customer }}" id="input-customer" data-oc-target="autocomplete-customer" autocomplete="off">
												<ul id="autocomplete-customer" class="dropdown-menu"></ul>
												{# <input type="text" class="input-group" name="customer" value="{{ customer }}" placeholder="{{ entry_customer }}" id="input-customer"> #}
												<!-- v4-->
												<input type="hidden" name="customer_id" id="customer_id" value="{{ customer_id }}"/>
													<a href="{{ button_add_customer }}" target="_blank" id="button-addon2" class="btn btn-outline-primary">
														<i class="fa fa-plus"></i>
														&nbsp; Skapa kund</a>
												<!-- v4-->
											</div>
										</div>
										<div class="col-sm-4" style="margin-top:19px;">
											<a  {% if customer_id %} class="btn btn-outline-primary" target="_blank" href="index.php?route=customer/customer.form&user_token={{user_token}}&customer_id={{customer_id}}" {% else %} class="btn btn-outline-primary disabled editCustomer" href="javascript:void(0)" {% endif %}>
												<i class="fa fa-pencil"></i>
												&nbsp; Ändra</a>
											<a href="javascript:void(0)" type="button" {% if customer_id %} class="btn btn-outline-primary" value="{{ customer_id }}" id="button-sync-details" {% else %} class="btn btn-outline-primary button-sync-details disabled" value="" id="button-sync-details" {% endif %} >
												<i class="fa fa-refresh"></i>
												&nbsp; Synka</a>
											<a href="javascript:void(0)" type="button" {% if customer_id %} class="btn btn-outline-primary" value="{{ customer_id }}" id="button-save-details" {% else %} class="btn btn-outline-primary button-save-details disabled" value="" id="button-save-details" {% endif %} >
												<i class="fa fa-save"></i>
												&nbsp; Spara ny address</a>
										</div>
									</div>
									<div class="clearfix"></div><hr>
									<div class="row">
										<div class="col-sm-3">
											<div class="form-group">
												<label>{{entry_vatno}}</label>
												<div class="input-group mb-3">
													{% for custom_field in custom_fields %}
													{% if custom_field.name == 'Vatnr'%}
													<input class="form-control input-sm" id="vatnr" type="text" name="custom_field[{{ custom_field.custom_field_id }}]" value="{{ account_custom_field[custom_field.custom_field_id] ? account_custom_field[custom_field.custom_field_id] : custom_field.value }}">
													<input id="custom_field_id_vatnr" type="hidden" name="" value="{{custom_field.custom_field_id}}">
													{% endif %}
													{% endfor %}
													<button class="btn btn-outline-secondary btn-sm" type="button" id="INvatno">
														<i class="fa fa-bolt"></i>
													</button>
												</div>
											</div>
										</div>
										<div class="col-sm-3">
											<div class="form-group">
												<label>Företag</label>
												<div class="input-group mb-3">
													{% for custom_field in custom_fields %}
													{% if custom_field.name == 'Företag'%}
													<input class="form-control input-sm" id="customer_company" type="text" name="custom_field[{{ custom_field.custom_field_id }}]" value="{{ account_custom_field[custom_field.custom_field_id] ? account_custom_field[custom_field.custom_field_id] : custom_field.value }}">
													<input id="custom_field_id_forerag" type="hidden" name="" value="{{custom_field.custom_field_id}}">
													{% endif %}
													{% endfor %}
													<button class="btn btn-outline-secondary btn-sm" type="button" id="INvatno">
														<i class="fa fa-bolt"></i>
													</button>
												</div>
											</div>
										</div>
										<div class="col-sm-3">
											<div class="form-group">
												<label>{{entry_firstname}}</label>
												<input class="form-control input-sm" type="text" name="input_firstname" value="{{ firstname }}" id="input-firstname" placeholder="{{entry_firstname}}">
											</div>
										</div>
										<div class="col-sm-3">
											<div class="form-group">
												<label>{{entry_lastname}}</label>
												<input class="form-control input-sm" type="text" name="input_lastname" value="{{ lastname }}" id="input-lastname" placeholder="{{entry_lastname}}">
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-sm-6">
											<label>{{entry_email}}</label>
											<input class="form-control input-sm" type="text" name="email" value="{{ email }}" id="input-email" placeholder="{{entry_email}}">
										</div>
										<div class="col-sm-6">
											<label>{{entry_telephone}}</label>
											<div class="input-group">
												<input class="form-control input-sm" type="text" name="telephone" value="{{ telephone }}" id="input-telephone" placeholder="{{entry_telephone}}">
												<button class="btn btn-outline-secondary btn-sm" type="button" id="INtelephone">
													<i class="fa fa-bolt"></i>
												</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="accordion-item">
							<h2 class="accordion-header" id="heading-payment-details">
								<button id="paymentdetails" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#payment-details" aria-expanded="false" aria-controls="payment-details">
									<i class="fa fa-credit-card"></i>
									&nbsp;{{tab_payment_detail}}</button>
							</h2>
							<div id="payment-details" class="accordion-collapse collapse" aria-labelledby="heading-payment-details" data-bs-parent="#accordionQuotationAdd">
								<div class="accordion-body">
									<div class="row mb-3">
										<div class="col-sm-9">
											<label>{{entry_address}}</label>
											<div class="input-group">
												<select class="form-select input-sm" name="payment_address" id="input-payment-address">
													<option value="0">{{ text_none }}</option>
													{% for address in addresses %}
													{% if payment_address_id == address.address_id %}
														<option value="{{ address.address_id }}" selected="selected">{{ address.firstname }}
															{{ address.lastname }},
															{{ address.address_1 }},
															{{ address.city }},
															{{ address.country }}</option>
													{% else %}
														<option value="{{ address.address_id }}">{{ address.firstname }}
															{{ address.lastname }},
															{{ address.address_1 }},
															{{ address.city }},
															{{ address.country }}</option>
													{% endif %}
													{% endfor %}
												</select>
												{# <a style="padding-top: 8px;" href="{{customerurl}}" onclick="window.open('{{customerurl}}', '_blank');" target="_blank" type="button" id="button-addon2" class="btn btn-outline-secondary btn-sm editaddress">
																									<i class="fa fa-pencil"></i>
																								</a> #}
											</div>
										</div>
										<div class="col-sm-3" style="margin-top:19px;display:flex;">
											<a  {% if customer_id %} class="btn btn-outline-primary" target="_blank" href="index.php?route=customer/customer.form&user_token={{user_token}}&customer_id={{customer_id}}" {% else %} class="btn btn-outline-primary disabled editCustomer" href="javascript:void(0)" {% endif %}>
												<i class="fa fa-pencil"></i>
												Ändra</a>
												<div class="dropdown mx-2">
													<button	class="btn btn-outline-primary dropdown-toggle"	type="button" id="dropdownMenuButton" data-mdb-toggle="dropdown" aria-expanded="false">
														Spara adress <i class="fa fa-angle-down"></i>
													</button>
													<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
														<li><a type="button" data-loading-text="{{ text_loading }}" id="savePaymentAddress" {% if payment_address_id %}  class="dropdown-item savePaymentAddress" value="{{payment_address_id}}" {% else %} class="dropdown-item disabled savePaymentAddress" {% endif %}>
															<i class="fa fa-save"></i>
															Uppdatera adress i kundkort</a></li>
														<li><a type="button" data-loading-text="{{ text_loading }}" id="savePaymentNewAddress" {% if payment_address_id %}  class="dropdown-item disabled savePaymentNewAddress" value="" {% else %} class="dropdown-item savePaymentNewAddress" {% endif %}>
															<i class="fa-solid fa-location-dot"></i>
															Spara som ny adress</a></li>
													</ul>
												</div>
											<button type="button" data-loading-text="{{ text_loading }}" id="syncPaymentAddress" {% if payment_address_id %}  class="btn btn-outline-primary" value="{{payment_address_id}}" {% else %} class="btn btn-outline-primary disabled" {% endif %}>
												<i class="fa fa-sync"></i>
												</button>
										</div>
									</div>
									<div class="clearfix"></div><hr>
									<div class="row mb-3">
										<div class="col-sm-3">
											<label>{{entry_firstname}}</label>
											<input placeholder="{{entry_firstname}}" class="form-control input-sm" type="text" name="input_payment_firstname" value="{{ payment_firstname }}" id="input-payment-firstname">
										</div>
										<div class="col-sm-3">
											<label>{{entry_lastname}}</label>
											<input placeholder="{{entry_lastname}}" class="form-control input-sm" type="text" name="input_payment_lastname" value="{{ payment_lastname }}" id="input-payment-lastname">
										</div>
										<div class="col-sm-3">
											<label>{{entry_company}}</label>
											<input placeholder="{{entry_company}}" class="form-control input-sm" type="text" name="input_payment_company" value="{{ payment_company }}" id="input-payment-company">
										</div>

										<!-- Custome filds-->
										{% for custom_field in custom_fields %}
											{% if custom_field.location == 'address' %}
												{% if custom_field.type == 'text' %}
													<div class="col-sm-3 custom-field custom-field{{ custom_field.custom_field_id }}" data-sort="{{ custom_field.sort_order + 3 }}">
														<label for="input-payment-custom-field{{ custom_field.custom_field_id }}">{{ custom_field.name }}</label>
														<input type="hidden" id="payment_custom_field_id" value="{{ custom_field.custom_field_id }}">
														<input class="form-control input-sm" type="text" name="payment_custom_field[{{ custom_field.custom_field_id }}]" value="{{ payment_custom_field[custom_field.custom_field_id] }}" placeholder="{{ custom_field.name }}" id="input-payment-custom-field{{ custom_field.custom_field_id }}"/>
													</div>
												{% endif %}
											{% endif %}
										{% endfor %}
										<!-- Custome filds-->

									</div>
									<div class="row mb-3">
										<div class="col-sm-3">
											<label>{{entry_address_1}}</label>
											<input placeholder="{{entry_address_1}}" class="form-control input-sm" type="text" name="input_payment_address_1" value="{{ payment_address_1 }}" id="input-payment-address-1">
										</div>
										<div class="col-sm-3">
											<label>{{entry_address_2}}</label>
											<input placeholder="{{entry_address_2}}" class="form-control input-sm" type="text" name="input_payment_address_2" value="{{ payment_address_2 }}" id="input-payment-address-2">
										</div>
										<div class="col-sm-2">
											<label>{{entry_postcode}}</label>
											<input placeholder="{{entry_postcode}}" class="form-control input-sm" type="text" name="input_payment_postcode" value="{{ payment_postcode }}" id="input-payment-postcode">
										</div>
										<div class="col-sm-4">
											<label>{{entry_city}}</label>
											<input placeholder="{{entry_city}}" class="form-control input-sm" type="text" name="input_payment_city" value="{{ payment_city }}" id="input-payment-city">
										</div>
										<div class="col-sm-6">
											<label>{{entry_country}}</label>
											<select class="form-select input-sm" name="input_payment_country_id" id="input-payment-country">

												<option value="">{{ text_select }}</option>
												{% for country in countries %}
													{% if country.country_id == payment_country_id %}
														<option value="{{ country.country_id }}" selected="selected">{{ country.name }}</option>
													{% else %}
														<option value="{{ country.country_id }}">{{ country.name }}</option>
													{% endif %}
												{% endfor %}
											</select>
										</div>
										<div class="col-sm-6">
											<label>{{entry_zone}}</label>
											<select class="form-control input-sm" name="input_payment_zone_id" id="input-payment-zone"></select>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="accordion-item">
							<h2 class="accordion-header" id="heading-shipping-details">
								<button id="shippingdetails" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#shipping-details" aria-expanded="false" aria-controls="shipping-details">
									<i class="fa fa-truck"></i>
									&nbsp;{{tab_shipping_detail}}</button>
							</h2>
							<div id="shipping-details" class="accordion-collapse collapse" aria-labelledby="heading-payment-details" data-bs-parent="#accordionQuotationAdd">
								<div class="accordion-body">
									<div class="row mb-3">
										<div class="col-sm-9">
											<label>{{entry_address}}</label>
											<div class="input-group">
												<select class="form-select input-sm" name="shipping_address" id="input-shipping-address">
													<option value="0">{{ text_none }}</option>
													{% for address in addresses %}
													{% if shipping_address_id == address.address_id %}
														<option value="{{ address.address_id }}" selected="selected">{{ address.firstname }}
															{{ address.lastname }},
															{{ address.address_1 }},
															{{ address.city }},
															{{ address.country }}</option>
													{% else %}
														<option value="{{ address.address_id }}">{{ address.firstname }}
															{{ address.lastname }},
															{{ address.address_1 }},
															{{ address.city }},
															{{ address.country }}</option>
													{% endif %}
													{% endfor %}
												</select>
												{# <a href="{{customerurl}}" onclick="window.open('{{customerurl}}', '_blank');" target="_blank" class="btn btn-outline-secondary btn-sm editaddress">
																									<i class="fa fa-pencil"></i>
																								</a> #}
											</div>
										</div>
										<div class="col-sm-3" style="margin-top:19px;display:flex;">
											<a  {% if customer_id %} class="btn btn-outline-primary" target="_blank" href="index.php?route=customer/customer.form&user_token={{user_token}}&customer_id={{customer_id}}" {% else %} class="btn btn-outline-primary disabled editCustomer" href="javascript:void(0)" {% endif %}>
												<i class="fa fa-pencil"></i>
												Ändra</a>
												<div class="dropdown mx-2">
													<button	class="btn btn-outline-primary dropdown-toggle"	type="button" id="dropdownMenuButton" data-mdb-toggle="dropdown" aria-expanded="false">
														Spara adress <i class="fa fa-angle-down"></i>
													</button>
													<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
														<li><a type="button" data-loading-text="{{ text_loading }}" id="saveShippingAddress" {% if shipping_address_id %}  class="dropdown-item saveShippingAddress" value="{{shipping_address_id}}" {% else %} class="dropdown-item disabled saveShippingAddress" {% endif %}>
															<i class="fa fa-save"></i>
															Uppdatera adress i kundkort</a></li>
														<li><a type="button" data-loading-text="{{ text_loading }}" id="saveShippingNewAddress" {% if shipping_address_id %}  class="dropdown-item disabled saveShippingNewAddress" value="" {% else %} class="dropdown-item saveShippingNewAddress" {% endif %}>
															<i class="fa-solid fa-location-dot"></i>
															Spara som ny adress</a></li>
													</ul>
												</div>
											<button type="button" data-loading-text="{{ text_loading }}" id="syncShippingAddress" {% if shipping_address_id %}  class="btn btn-outline-primary saveShippingAddress" value="{{shipping_address_id}}" {% else %} class="btn btn-outline-primary disabled saveShippingAddress" {% endif %}>
												<i class="fa fa-sync"></i>
											</button>

										</div>
									</div>
									<div class="clearfix"></div><hr>
									<div class="row mb-3">
										<div class="col-sm-3">
											<label>{{entry_firstname}}</label>
											<input placeholder="{{entry_firstname}}" class="form-control input-sm" type="text" name="input_shipping_firstname" value="{{ shipping_firstname }}" id="input-shipping-firstname">
										</div>
										<div class="col-sm-3">
											<label>{{entry_lastname}}</label>
											<input placeholder="{{entry_lastname}}" class="form-control input-sm" type="text" name="input_shipping_lastname" value="{{ shipping_lastname }}" id="input-shipping-lastname">
										</div>
										<div class="col-sm-3">
											<label>{{entry_company}}</label>
											<input placeholder="{{entry_company}}" class="form-control input-sm" type="text" name="input_shipping_company" value="{{ shipping_company }}" id="input-shipping-company">
										</div>

										<!-- Custome filds-->
										{% for custom_field in custom_fields %}
											{% if custom_field.location == 'address' %}
												{% if custom_field.type == 'text' %}
													<div class="col-sm-3 custom-field custom-field{{ custom_field.custom_field_id }}" data-sort="{{ custom_field.sort_order + 3 }}">
														<label for="input-shipping-custom-field{{ custom_field.custom_field_id }}">{{ custom_field.name }}</label>
														<input type="hidden" id="shipping_custom_field_id" value="{{ custom_field.custom_field_id }}">
														<input type="text" name="shipping_custom_field[{{ custom_field.custom_field_id }}]" value="{{ shipping_custom_field[custom_field.custom_field_id]}}" placeholder="{{ custom_field.name }}" id="input-shipping-custom-field{{ custom_field.custom_field_id }}" class="form-control input-sm"/>
													</div>
												{% endif %}
											{% endif %}
										{% endfor %}
										<!-- Custome filds-->
									</div>
									<div class="row mb-3">
										<div class="col-sm-3">
											<label>{{entry_address_1}}</label>
											<input placeholder="{{entry_address_1}}" class="form-control input-sm" type="text" name="input_shipping_address_1" value="{{ shipping_address_1 }}" id="input-shipping-address-1">
										</div>
										<div class="col-sm-3">
											<label>{{entry_address_2}}</label>
											<input placeholder="{{entry_address_2}}" class="form-control input-sm" type="text" name="input_shipping_address_2" value="{{ shipping_address_2 }}" id="input-shipping-address-2">
										</div>
										<div class="col-sm-2">
											<label>{{entry_postcode}}</label>
											<input placeholder="{{entry_postcode}}" class="form-control input-sm" type="text" name="input_shipping_postcode" value="{{ shipping_postcode }}" id="input-shipping-postcode">
										</div>
										<div class="col-sm-4">
											<label>{{entry_city}}</label>
											<input placeholder="{{entry_city}}" class="form-control input-sm" type="text" name="input_shipping_city" value="{{ shipping_city }}" id="input-shipping-city">
										</div>
										<div class="col-sm-6">
											<label>{{entry_country}}</label>
											<select class="form-select input-sm" name="input_shipping_country_id" id="input-shipping-country">
												<option value="">{{ text_select }}</option>
												{% for country in countries %}
													{% if country.country_id == shipping_country_id %}
														<option value="{{ country.country_id }}" selected="selected">{{ country.name }}</option>
													{% else %}
														<option value="{{ country.country_id }}">{{ country.name }}</option>
													{% endif %}
												{% endfor %}

											</select>
										</div>
										<div class="col-sm-6">
											<label>{{entry_zone}}</label>
											<select class="form-select input-sm" name="input_shipping_zone_id" id="input-shipping-zone"></select>
										</div>


									</div>
								</div>
							</div>
						</div>
						<div class="accordion-item">
							<h2 class="accordion-header" id="heading-attachments">
								<button id="attachmentsdetails" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#attachments-detail" aria-expanded="false" aria-controls="attachments-detail">
									<i class="fa fa-paperclip"></i>
									&nbsp;Bifogade filer</button>
							</h2>
							<div id="attachments-detail" class="accordion-collapse collapse" aria-labelledby="heading-payment-details" data-bs-parent="#accordionQuotationAdd">
								<div class="accordion-body">
									<div class="input-group mb-3">
										<div class="input-group-prepend">
											<span class="input-group-text input-sm" id="basic-addon3">
												<i class="fa fa-file-text"></i>&nbsp;
																																						Korrektur/URL</span>
										</div>
										<input type="text" class="form-control input-sm" name="file_final_sketch" value="{{file_final_sketch}}" placeholder="Ange Google drive länk" style="background: transparent;border: 1px solid #373e47;border-radius: 0;">
									</div>
									<hr>
									<!-- file upload-->
									<div class="row">
										<div class="well detailbox show_hide_box" id="fileuploadbox" style="background:none; border:none;">
											<br>
											<!-- The fileinput-button span is used to style the file input field as button -->
											<span class="btn btn-primary fileinput-button">
												<i class="fa fa-plus"></i>
												<span>{{button_add_filtes}}...</span>
												<!-- The file input field used as target for the file upload widget -->
												<input id="fileupload" data-url="{{uploadUrl}}" type="file" name="files[]" multiple>
											</span>
											<br>
											<br>
											<!-- The global progress bar -->
											<div id="progress" class="progress">
												<div class="progress-bar progress-bar-success"></div>
											</div>
											<!-- The container for the uploaded files -->
											<div id="files" class="files"></div>
											<input type="hidden" name="files_data" id="files_data" value="{{files_data}}">

											<table class="table" id="files-table">
												<thead>
													<tr>
														<th style="width:25%"></th>
														<th>Filename</th>
														<th>Type</th>
														<th style="width:10%">Size</th>
														<th style="width:10%">Actions</th>
													</tr>
												</thead>
												<tbody></tbody>
											</table>

										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="accordion-item">
							<h2 class="accordion-header" id="heading-attachments">
								<button id="shippingLabelDetails" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#shipping-label-detail" aria-expanded="false" aria-controls="attachments-detail">
									<i class="fa fa-truck"></i>
									&nbsp;Fraktsedel</button>
							</h2>
							<div id="shipping-label-detail" class="accordion-collapse collapse" aria-labelledby="heading-payment-details" data-bs-parent="#accordionQuotationAdd">
								<div class="accordion-body">
									<table class="table table-hover table-bordered" id="shipment_table">
									<thead>
										<tr>
										<th scope="col">SHIPMENT ID</th>
										<th scope="col">WEIGHT</th>
										<th scope="col">QUANTITY</th>
										<th scope="col">CARRIER</th>
										<th scope="col">PRODUCT TYPE</th>
										<th scope="col">PACKAGE TYPE</th>
										<th scope="col">SERVICE ADDONS</th>
										<th scope="col">DATE CREATED</th>
										<th scope="col"></th>
										</tr>
									</thead>
									<tbody>
									{% if shipment_details != '' %}
									{% for shipment in shipment_details %}
										<tr>
										<td scope="row">{{shipment.shipment_id}}</th>
										<td>{{shipment.weight}}</td>
										<td>{{shipment.quantity}}</td>
										<td>{{shipment.carrier}}</td>
										<td>{{shipment.product_type}}</td>
										<td>{{shipment.package_type}}</td>
										<td><ul>{% for addon in shipment.service_addons %}
										<li>{{addon}}</li>
											{% endfor %}
										</ul></td>
										<td>{{shipment.date_created}}</td>
										<td><a type="button" href="index.php?route=codevoc/b2bmanager_shipmondo.downloadShipmentPdf&user_token={{ user_token }}&shipment_id={{shipment.id}}" class="btn btn-sm btn-primary" id="" value="{{shipment.id}}"><i class="fa fa-download"></i> DOWNLOAD PDF</button></td>
										</tr>
									{% endfor %}
									{% else %}
										<tr style="text-align:center;">
											<td colspan="9">No Shipments Available</td>
										</tr>
									{% endif %}
									</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
					<div class="clearfix h10"></div>

				</div>
			</div>

			<div id="image_div"></div>
			<!-- for article-->

			<div class="card">
				<div class="card-header">
					Artiklar
				</div>
				<div class="row">
					<div
						class="col-sm-12">
						<!-- article-->

					<input type="hidden" name="article" value="1">
				<table class="table table-bordered table-hover table-sm" id="article" style="font-size:9px;">
					<thead>
						<tr>
							<th scope="col" style="text-align: center;width: 1%;"><input type="checkbox" class="countArticle selectAll"></th>
							<th style="width:14%" scope="col">{{column_model}}</th>
							<!-- discount price calculation set to width 25% to 22%-->
							<th style="width:25%" scope="col">{{column_title}}</th>
							<th style="width:6%" scope="col">{{column_qty}}</th>
							<!-- discount price calculation set to width 25% to 20%-->
							<th style="width:18%" scope="col">{{column_options}}</th>
							<!-- discount price calculation-->
							<th style="width:7%" scope="col">A-pris</th>
							<!-- discount price calculation-->
							<th style="width:7%" scope="col">Rabatt %</th>
							<th style="width:6%" scope="col">{{column_percantage}}</th>
							{# <th style="width:9%" scope="col">{{column_tax}}</th> #}
							<th style="width:9%" scope="col">{{column_total}}</th>
							<th scope="col"> </th>
							<th></th>
							{# <th></th> #}
							<th></th>
						</tr>
					</thead>
					<tbody>
							{% if order_products %}
							{% set product_row = 0 %}
							{% for order_product in order_products %}
								<button type="button" id="addEmptyRow" onclick="addarticlerow();" style="display:none;"></button>
								<tr id="article_row{{product_row}}">
									<td style="text-align: center;"><input type="checkbox" class="countArticle"></td>
									<input type="hidden" class="sort_order" name="order_products[{{product_row}}][sort_order]" value="">
									<td><input class="form-control" type="text" name="order_products[{{product_row}}][model]" value="{{ order_product.model }}" placeholder="{{column_model}}" id="article_nr{{product_row}}" data-oc-target="autocomplete-article-nr{{product_row}}" autocomplete="off">
									<ul id="autocomplete-article-nr{{product_row}}" class="dropdown-menu"></ul>
									<input type="hidden" name="order_products[{{product_row}}][product_id]" value="{{order_product.product_id}}" id="productrow{{product_row}}">
									</td>
									<td><input type="text" class="form-control" name="order_products[{{product_row}}][name]" value="{{order_product.name}}" placeholder="{{column_title}}" id="productname{{product_row}}"></td>
									<td><input class="form-control" onkeyup="pricecal();" class="ctrl_quantity" min="1" type="number" name="order_products[{{product_row}}][quantity]" value="{{order_product.quantity}}" placeholder="{{column_qty}}" id="quantity{{product_row}}"></td>
									<td id="options{{product_row}}">
									<input type="hidden" id="product_option_id{{product_row}}" value="">
									{% set counter_row = 0 %}
										{% for options in order_product.option %}
											{% if options.type == 'select' %}
											<!-- v5-->
											<input type="hidden" id="optionprice{{product_row}}_{{counter_row}}" value="{{options.opprice}}">
											<!-- v5-->
											<select class="form-select form-select-sm" onchange="oppricecal({{product_row}},{{counter_row}});" id="optiondropdown{{product_row}}_{{counter_row}}" class="options-list" name='order_products[{{product_row}}][option][{{options.product_option_id}}]'>
											<option value="" selected>{{options.name}}</option>
											{% for product_option_value in options.product_option_value %}
											{% if product_option_value.selected =='selected' %}
											<option value='{{product_option_value.product_option_value_id}}' selected="selected">{{product_option_value.name}}</option>
											{% else %}
											<option value='{{product_option_value.product_option_value_id}}'>{{product_option_value.name}}</option>
											{% endif %}
											{% endfor %}
											</select>
											{% set counter_row = counter_row + 1 %}
											{% endif %}
											{% endfor %}
									</td>
										<td> 
										<input class="form-control" type="text" value="{{order_product.org_price}}" placeholder="{{column_org_price}}" id="oprice{{product_row}}" name="order_products[{{product_row}}][oprice]" readonly="readonly">
										<input type="hidden" id="oprice_v{{product_row}}" name="order_products[{{product_row}}][oprice_v]" value="{{order_product.price}}">
										</td>
										<td><input  class="form-control" onkeyup="pricecal();" type="text" value="{{order_product.price}}" placeholder="{{column_price}}" id="price{{product_row}}" readonly="readonly">
											<input type="hidden" id="pprice{{product_row}}" name="order_products[{{product_row}}][price]" value="{{order_product.price}}"></td>
										<td><input class="form-control" onkeyup="pricecal();" type="text" name="order_products[{{product_row}}][price_discount_percentage]" value="{{order_product.price_discount_percentage}}" placeholder="{{column_percantage}}" id="price_discount_percentage{{product_row}}">
										</td>
										<td style="display:none;"id="tax_classes{{product_row}}">
											<input type="hidden" name="order_products[{{product_row}}][tax_class_id]" value="{{order_product.tax_class_id}}">
											<input type="hidden" id="total_tax{{product_row}}" value="{{order_product.total_tax_rate}}">
											<input type="hidden" id="total_tax_to_prod{{product_row}}" name="order_products[{{product_row}}][total_tax_to_prod]" value="{{order_product.tax}}">
										</td>
										<td><input class="form-control" type="text" name="order_products[{{product_row}}][total]" value="{{order_product.total}}" placeholder="{{column_total}}" id="total{{ product_row }}" readonly="readonly"></td>
										<td><i class="fa fa-minus" onclick="$('#article_row{{product_row}}').remove();checkEmpty();removerow();"></i></td>
										<td style="text-align: center; cursor:pointer;"><i class="fa fa-plus" onclick="addarticlerow();"></i></td>
										<td style="text-align: center; cursor:pointer;"><i class="fa fa-copy" onclick="copyarticlerow('{{product_row}}');"></i></td>
										<td><i class="fa fa-arrows sorter" data-move></i><input type="hidden" class="sort_order" name="order_products[{{product_row}}][sort_order]" value=""></td>
								</tr>
								{% set product_row = product_row + 1 %}
							{% endfor %}
							{% endif %}
					</tbody>
					<tfoot>						
						<tr>
							<td colspan="5">
								{# <span>Antal rader: <span id="totalarticles">0</span>  Antal artiklar: <span id="totalarticles_quantity">0</span></span> #}
							</td>
							<td colspan="3">
								<!-- apply button-->
								<div class="col-sm-12 text-right">
								<button type="button" id="button-addrow" onclick="addarticlerow();" data-loading-text="{{ text_loading }}" class="btn btn-primary btn-sm"> Add New Row</button>
								</div>
								<!-- apply button-->
							</td>
						</tr>
					</tfoot>
				</table>
				<!-- article-->
			</div>
			</div>
		</div>
			<div class ="row">
				<div class="col-sm-4 mt-3"><button type="button" id="button-product-add" data-loading-text="{{ text_loading }}" class="btn btn-primary">{{ button_apply }}</button></div>
				<div class="col-sm-4"></div>
					<div class="col-sm-4">
						<ul class="order-totals">
						{% if order_totals %}
							{% for total in order_totals %}
								<li>
									<span class="order-total-name">{{ total.title }} : </span>
									<input type="hidden" name="{{total.code}}" class="{{total.code}}" value="{{ total.text }}"/>
									<span class="order-total-price {{total.code}}" id="{{total.code}}">{{ total.text }}</span>
								</li>
							{% endfor %}
						{% else %}
								<li>
									<span class="order-total-name">Sub-Total</span>
									<input type="hidden" name="sub_total" class="sub_total"/>
									<span class="order-total-price sub_total" id="sub_total" ></span>
								</li>
								<li>
									<span class="order-total-name">Shipping</span>
									<input type="hidden" name="shipping_cost" class="shipping_cost"/>
									<span class="order-total-price" id="shipping_cost"></span>
								</li>
								<li>
									<span class="order-total-name">Tax</span>
									<input type="hidden" name="tax"  class="tax"/>
									<span class="order-total-price tax" id="tax"></span>
								</li>
								<li>
									<span class="order-total-name">Total</span>
									<input type="hidden" name="total"  class="total" value="{{total}}"/>
									<span class="order-total-price total" id="total"></span>
								</li>
						{% endif %}
						</ul>
					</div>
			</div>
			<div class="card">
				<div class="card-header"><i class="fa-solid fa-clock"></i> Order History <span class="float-end"><button type="button" id="add_history" class="btn btn-sm btn-primary">ADD HISTORY <i class="fa-solid fa-play"></i></button></span></div>
				<div class="card-body">
					<div id="history">{{ history }}</div>
				</div>
			</div>

</div>
		<input type="hidden" name="finalstep" id="finalstep" value="0">
		<input type="hidden" name="finalstep2" id="finalstep2" value="0">
        <input type="hidden" name="shipping_tax" id="shipping_tax" value="0">
		<input type="hidden" name="order_id" value="{{ order_id }}"/>
		<input type="hidden" id="totalrow" name="totalrow" value="{{product_row}}"/>
        <input type="hidden" id="files_v" name="files" value="{{files}}"/>
	</form>
	<div class="modal fade" id="historyModal" tabindex="-1" role="dialog" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyModalLabel">ADD HISTORY</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <form id="form-history">
              <fieldset>
                <legend>{{ text_history_add }}</legend>
                <div class="row mb-3">
				  <div class="col-sm-12">
                    <label for="input-order-status" class="col-sm-2 col-form-label">{{ entry_order_status }}</label>
                    <select name="order_status_id" id="input-order-status" class="form-select">
                      {% for order_status in order_statuses %}
                        <option value="{{ order_status.order_status_id }}"{% if order_status.order_status_id == order_status_id %} selected{% endif %}>{{ order_status.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
				<div class="row mb-3">
				  <div class="col-sm-9">
                    <label for="input-text" class="col-sm-10 col-form-label">Predefined Text</label>
					<select name="input_text" id="input-text" class="form-select" style="width: 110%;">
                        <option value="text" selected>Text</option>
                    </select>
                  </div>
				  <div class="col-sm-3 float-end">
					<button style="margin-top: 37px;" type="button" id="add-input-text" class="btn btn-primary float-end">Add New</button>
                  </div>
                </div>
                <div class="row mb-3">
				  <div class="col-sm-12">
                    <label for="input-history" class="col-sm-2 col-form-label">{{ entry_comment }}</label>
                    <textarea name="comment" rows="8" placeholder="{{ entry_comment }}" id="input-history" class="form-control"></textarea>
                  </div>
                </div>
				<div class="row mb-3">
				  <div class="col-sm-6">
                    <label for="input-override" class="col-sm-6 col-form-label">{{ entry_override }}</label>
                    <div class="form-check form-switch form-switch-lg">
                      <input type="hidden" name="override" value="0"/> <input type="checkbox" name="override" value="1" id="input-override" class="form-check-input">
                    </div>
                    <div class="form-text">{{ help_override }}</div>
                  </div>
				  <div class="col-sm-6">
                    <label for="input-notify" class="col-sm-6 col-form-label">{{ entry_notify }}</label>
                    <div class="form-check form-switch form-switch-lg">
                      <input type="hidden" name="notify" value="0"/> <input type="checkbox" name="notify" value="1" id="input-notify" class="form-check-input"/>
                    </div>
                  </div>
                </div>
                <div class="text-end">
                </div>
              </fieldset>
              <input type="hidden" name="order_id" value="{{ order_id }}" id="input-order-id"/>
            </form>
            </div>
            <div class="modal-footer">
                <button type="submit" id="button-history" class="btn btn-primary text-right"><i class="fa-solid fa-plus-circle"></i> {{ button_history_add }}</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
            </div>
        </div>
    </div>
	<div class="modal fade" id="shippingModal" tabindex="-1" role="dialog" aria-labelledby="shippingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shippingModalLabel">Fraktsedel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="shipments">
                <div class="row">
                    <div class="col-sm-4">
						<input type="hidden" value="{{order_id}}" name="order_id">
                        <label for="shipping_carrier" class="col-form-label">Shipping Carrier:</label>
                        <select class="form-select" id="shipping_carrier" name="shipping_carrier">
                            <option>---Please select---</option>
                        </select>
                    </div>
                    <div class="col-sm-4">
                        <label for="product_type" class="col-form-label">Product Type:</label>
                        <select class="form-select" id="product_type" name="product_type">
                            <option>---Please select---</option>
                        </select>
                    </div>
                    <div class="col-sm-4">
                        <label for="packing_type" class="col-form-label">Packing Type:</label>
                        <select class="form-select" id="packing_type" name="packing_type">
                            <option>---Please select---</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <label for="from_address" class="col-form-label">From Address</label>
                        <select class="form-select" id="from_address" name="from_address">
                            <option>---Please select---</option>
                        </select>
                    </div>
                    <div class="col-sm-4">
                        <label for="pickup_address" class="col-form-label">Pick-up Address</label>
                        <select class="form-select" id="pickup_address" name="pickup_address">
                            <option>---Please select---</option>
                        </select>
                    </div>
                    <div class="col-sm-4">
                        <label for="delivery_address" class="col-form-label">Delivery Address</label>
                        <select class="form-select" id="delivery_address" name="delivery_address">
                            <option>---Please select---</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <label for="height" class="col-form-label">Height</label>
                        <input type="text" class="form-control" placeholder="cm" id="height" name="height">
                    </div>
                    <div class="col-sm-4">
                        <label for="width" class="col-form-label">Width</label>
                        <input type="text" class="form-control" placeholder="cm" id="width" name="width">
                    </div>
                    <div class="col-sm-4">
                        <label for="Length" class="col-form-label">Length</label>
                        <input type="text" class="form-control" placeholder="cm" id="Length" name="Length">   
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <label for="quantity" class="col-form-label">Quantity</label>
                        <input type="text" class="form-control" placeholder="Quantity" id="quantity" name="quantity">
                    </div>
                    <div class="col-sm-4">
                        <label for="weight" class="col-form-label">Weight</label>
                        <input type="text" class="form-control" placeholder="Weight" id="weight" name="weight">
                    </div>
                    <div class="col-sm-4"></div>
                </div>
                <hr>
                        <label for="message-text" class="col-form-label">Service Addons:</label><br>
                        <div id="service_addons">No addons available</div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="create_shipment" value="">Generate Label</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="invoiceModal" tabindex="-1" role="dialog" aria-labelledby="invoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceModalLabel">Skapa faktura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                <div class="row">
                    <div class="col-sm-12">
                        <button type="button" class="btn btn-primary" id="generate_invoice" value="{{order_id}}">Skapa faktura</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
                </form>
            </div>
            <div class="modal-footer">
                
            </div>
            </div>
        </div>
        </div>

<!-- Modal -->

 <!-- file upload-->
<script type="text/javascript">
$('#add_history').on('click',function(){
	$('#historyModal').modal('show');
});
   $('#history').delegate('.pagination a', 'click', function(e) {
   	e.preventDefault();

   	$('#history').load(this.href);
   });
$('#button-history').on('click', function(e) {
    e.preventDefault();
                 var sendmail_delivery = false
                 var order_status_id = $('#input-order-status').val()
                 //if(order_status_id == 5){
                        if(confirm("Vill du skicka leveransbekräftelse? Om lagerupphämtning välj avbryt/cancel = inget mail skickas.")) {
                                sendmail_delivery = true
                        }
                // }
				if(sendmail_delivery) {
                         $.ajax({
                                url: 'index.php?route=codevoc/b2bmanager_order.sendmail_delivery&user_token={{ user_token }}&order_id={{ order_id }}&email={{ email }}',
                                type: 'post',
                                dataType: 'html',
                        });
                 }

    $.ajax({
        url: 'index.php?route=codevoc/b2bmanager_order.call&user_token={{ user_token }}&action=sale/order.addHistory&store_id=' + $('#input-store').val() + '&language=' + $('#input-language').val() + '&order_id=' + $('#input-order-id').val(),
        type: 'post',
        dataType: 'json',
        data: $('#form-history').serialize(),
        contentType: 'application/x-www-form-urlencoded',
        beforeSend: function() {
            $('#button-history').button('loading');
        },
        complete: function() {
            $('#button-history').button('reset');
        },
        success: function(json) {
            $('.alert-dismissible').remove();

            if (json['error']) {
				$('#historyModal').modal('hide');
                $('#alert').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa-solid fa-circle-exclamation"></i> ' + json['error'] + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
            }

            if (json['success']) {
                $('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> ' + json['success'] + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');

                $('#history').load('index.php?route=codevoc/b2bmanager_order.history&user_token={{ user_token }}&order_id=' + $('#input-order-id').val());

                $('#input-history').val('');

				$('#historyModal').modal('hide');
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

$('#history').load('index.php?route=codevoc/b2bmanager_order.history&user_token={{ user_token }}&order_id={{ order_id }}');

$('#orderType').on('change',function(){
	var order_id = $('input[name=\'order_id\']').val();
	var orderType = $(this).val();
    url = 'index.php?route=codevoc/b2bmanager_order.changeOrderType&user_token={{ user_token }}&order_id='+order_id;
    $.ajax({
		url: url,
		dataType: 'json',
		type : 'post',
		data : {
			order_type : orderType,
		},
		success: function(json) {
			if(json['response']==1){
				$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Order type changed successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
			}

		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
});

$('#shipping_label').on('click',function(){
	var selected = 0;
        url = 'index.php?route=codevoc/b2bmanager_shipmondo.shipmondoCarriers&user_token={{ user_token }}';
    	$.ajax({
		url: url,
		dataType: 'json',
		success: function(json) {
        html = '<option disabled>---Please select---</option>';
        for(i=0; i < json.length; i++){
			if(json[i]['code'] == 'dhl_freight_se'){
				html += '<option value="'+ json[i]['code'] +'" selected>'+json[i]['name']+'</option>';
				var carrierCode = json[i]['code'];
			}else{
				html += '<option value="'+ json[i]['code'] +'">'+json[i]['name']+'</option>';
			}
            
        }
         $('#shipping_carrier').html(html);
		 $('#service_addons').html('No addons available');
		 $('#packing_type').html('<option disabled>---Please select---</option>');
         $('#shippingModal').modal('show');
         //$('#shipping_carrier').prop('selectedIndex',0);
		 if(carrierCode){
			url = 'index.php?route=codevoc/b2bmanager_shipmondo.shipmondoProducts&user_token={{ user_token }}';
			$.ajax({
			url: url,
			dataType: 'json',
			type:'post',
			data:{
				carrierCode : carrierCode,
			},
			success: function(json) {
			html = '<option disabled selected>---Please select---</option>';
			for(i=0; i < json.length; i++){
				html += '<option value="'+ json[i]['code'] +'">'+json[i]['name']+'</option>';
			}
			$('#product_type').html(html);

			},
			error: function(xhr, ajaxOptions, thrownError) {
				alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			}
			});
		 }
         $('#product_type').prop('selectedIndex',0);
         $('#packing_type').prop('selectedIndex',0);

		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});

   var order_id = $('input[name=\'order_id\']').val();
   	$.ajax({
		url: 'index.php?route=codevoc/b2bmanager_shipmondo.orderAddress&user_token={{ user_token }}',
		dataType: 'json',
		type:'post',
		data:{
			order_id : order_id,
		},
		success: function(json2) {
			var addresses = json2.address;
			var optionStr = '';
			html = '<option disabled>---Please select---</option>';
			html_delivery = '<option disabled selected>---Please select---</option>';
			for(i=0; i < addresses.length; i++){
				if(addresses[i]['type'] == 'custom'){
					optionStr = addresses[i]['firstname']+' '+addresses[i]['lastname'] + ' | '+addresses[i]['email'] +' | '+addresses[i]['telephone'] + ' | '+ addresses[i]['address_1'] +' | '+addresses[i]['postcode'] +' | '+addresses[i]['city'] +' | '+addresses[i]['iso_code_2'];
					html += '<option value="'+ addresses[i]['type'] +'" selected>'+optionStr+'</option>';
				}else{
					if(addresses[i]['company'] == ''){
						optionStr = addresses[i]['firstname']+' '+addresses[i]['lastname'] + ' | '+addresses[i]['email'] +' | '+addresses[i]['telephone'] + ' | '+ addresses[i]['address_1'] + ' | '+addresses[i]['address_2'] +' | '+addresses[i]['postcode'] +' | '+addresses[i]['city'] + ' | '+addresses[i]['country']+' | '+addresses[i]['iso_code_2'];
					}else{
						optionStr = addresses[i]['company'] +' | '+addresses[i]['firstname']+' '+addresses[i]['lastname'] + ' | '+addresses[i]['email'] +' | '+addresses[i]['telephone'] + ' | '+ addresses[i]['address_1'] + ' | '+addresses[i]['address_2'] +' | '+addresses[i]['postcode'] +' | '+addresses[i]['city'] + ' | '+addresses[i]['country']+' | '+addresses[i]['iso_code_2'];
					}
					html += '<option value="'+ addresses[i]['type'] +'">'+optionStr+'</option>';
					html_delivery += '<option value="'+ addresses[i]['type'] +'">'+optionStr+'</option>';
				}
			}
			$('#from_address').html(html);
			$('#pickup_address').html(html);
			$('#delivery_address').html(html_delivery);
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
   
});

$('#shipping_carrier').on('change',function(){
    carrierCode = $(this).val();
        url = 'index.php?route=codevoc/b2bmanager_shipmondo.shipmondoProducts&user_token={{ user_token }}';
    	$.ajax({
		url: url,
		dataType: 'json',
        type:'post',
        data:{
            carrierCode : carrierCode,
        },
		success: function(json) {
        html = '<option>---Please select---</option>';
        for(i=0; i < json.length; i++){
            html += '<option value="'+ json[i]['code'] +'">'+json[i]['name']+'</option>';
        }
        $('#product_type').html(html);

		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
		});
});

$('#product_type').on('click',function(){
    productType = $(this).val();
    url = 'index.php?route=codevoc/b2bmanager_shipmondo.shipmondoPackageType&user_token={{ user_token }}';
    $.ajax({
		url: url,
		dataType: 'json',
        type:'post',
        data:{
            productType : productType,
        },
		success: function(json) {
        html = '<option>---Please select---</option>';
        for(i=0; i < json.length; i++){
            html += '<option value="'+ json[i]['code'] +'">'+json[i]['description']+'</option>';
        }
        $('#packing_type').html(html);

		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});

		$.ajax({
			url: 'index.php?route=codevoc/b2bmanager_shipmondo.shipmondoProducts&user_token={{ user_token }}',
			dataType: 'json',
			type:'post',
			data:{
				productType : productType,
			},
			success: function(json1) {
			html1 = '<div class="row" style="margin-left:10px">'; 
			for(i=0; i < json1[0]['available_services'].length; i++){
				if(json1[0]['available_services'][i]['own_agreement_required'] != 1){
					html1 += '<div class="form-check form-switch col-sm-2"><input class="form-check-input" type="checkbox" name="service_addons['+json1[0]['available_services'][i]['code']+']" id="flexSwitchCheckDefault"><label class="form-check-label" for="flexSwitchCheckDefault" value="'+json1[0]['available_services'][i]['code']+'">'+json1[0]['available_services'][i]['name']+'</label></div>';
				}
			}
			html1 += '</div>'
			$('#service_addons').html(html1);

			},
			error: function(xhr, ajaxOptions, thrownError) {
				alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			}
		});


});

$('#create_shipment').on('click', function(){
    $.ajax({
        url: 'index.php?route=codevoc/b2bmanager_shipmondo.createShipment&user_token={{ user_token }}',
        type: 'post',
        dataType: 'json',
        data: $('#shipments').serialize(),
        contentType: 'application/x-www-form-urlencoded',
        beforeSend: function() {
            $('#create_shipment').button('loading');
        },
        complete: function() {
            $('#create_shipment').button('reset');
        },
        success: function(json) {
            $('.alert-dismissible').remove();

            if (json['error']) {
                $('#alert').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa-solid fa-circle-exclamation"></i> ' + json['error'] + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
            }

            if (json['success']) {
				    $.ajax({
						url: 'index.php?route=codevoc/b2bmanager_order.getShipment&user_token={{ user_token }}&order_id='+$('input[name=\'order_id\']').val(),
						type: 'post',
						dataType: 'json',
						contentType: 'application/x-www-form-urlencoded',
						success: function(shipments) {
							var html = '';
							for(i=0; i < shipments['shipment_details'].length; i++){
								html +=	'<tr>';
								html +=	'<td scope="row">'+shipments['shipment_details'][i]['shipment_id']+'</th>';
								html +=	'<td>'+shipments['shipment_details'][i]['weight']+'</td>';
								html +=	'<td>'+shipments['shipment_details'][i]['quantity']+'</td>';
								html +=	'<td>'+shipments['shipment_details'][i]['carrier']+'</td>';
								html +=	'<td>'+shipments['shipment_details'][i]['product_type']+'</td>';
								html +=	'<td>'+shipments['shipment_details'][i]['package_type']+'</td>';
								html +=	'<td><ul>';
								for(j=0; j < shipments['shipment_details'][i]['service_addons'].length; j++){
									html +=	'<li>'+shipments['shipment_details'][i]['service_addons'][j]+'</li>';
								}
								
								html +=	'</ul></td>';
								html +=	'<td>'+shipments['shipment_details'][i]['date_created']+'</td>';
								html +=	'<td><button type="button" class="btn btn-sm btn-primary" value="'+shipments['shipment_details'][i]['id']+'"href="index.php?route=codevoc/b2bmanager_shipmondo.downloadShipmentPdf&user_token={{ user_token }}&shipment_id='+shipments['shipment_details'][i]['id']+'" class="btn btn-sm btn-primary" id="shipment_pdf" value="{{shipment.id}}" id=""><i class="fa fa-download"></i> DOWNLOAD PDF</button></td>';
								html +=	'</tr>';
							}
							$('#shipment_table tbody').html(html);
							$('#shippingModal').modal('hide');
							$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> ' + json['success'] + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
						},
						error: function(xhr, ajaxOptions, thrownError) {
							console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
						}
					});
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

$('#shipment_pdf').on('click',function(){
	shipment_id = $(this).val();
	$.ajax({
		url: 'index.php?route=codevoc/b2bmanager_shipmondo.downloadShipmentPdf&user_token={{ user_token }}&shipment_id='+shipment_id,
		dataType: 'json',
		success: function(json) {
			console.log(json);
			$('#image_div').html(atob(json));
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});

});
	 


$('#create_invoice').on('click',function(){
    $('#invoiceModal').modal('show');
});

$('#generate_invoice').on('click',function(){
    order_id = $(this).val();
    url = 'index.php?route=codevoc/b2bmanager_fortnox.createinvoice&user_token={{ user_token }}&order_id='+order_id;
    $.ajax({
		url: url,
		dataType: 'json',
		success: function(json) {
            console.log(json);

		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
});
    /*jslint unparam: true, regexp: true */
    /*global window, $ */
    $(function () {
        'use strict';

        // Change this to the location of your server-side upload handler:
        var url = $("#fileupload").data("url"),
            uploadButton = $('<button/>')
                .addClass('btn btn-primary')
                .prop('disabled', true)
                .text('Processing...')
                .on('click', function () {
                    var $this = $(this),
                        data = $this.data();
                    $this
                        .off('click')
                        .text('Abort')
                        .on('click', function () {
                            $this.remove();
                            data.abort();
                        });
                    data.submit().always(function () {
                        $this.remove();
                    });
                });
                if($('#files_v').val()){
                var files = $('#files_v').val();
                }else{
                    var files = '';
                }
        

        var updateFileData = function () {
            var file_names = new Array();
            $.each(files, function (index, file) {
                file_names.push(file.name);
            });
            file_names = file_names.join("__|__");
            $("#files_data").val(file_names);
        };


        // handle delete click
        $(document).on("click", "#files-table tr td a.remove", function () {
            var filename = $(this).data('filename');
            var type = $(this).data('filetype');
            var $this = $(this);
            if (type == "temp") {
                if (filename != "") {
                    $.ajax({
                        url: "{{deleteUrl}}",
                        type: 'POST',
                        data: {
                            filename: filename,
                            type: type
                        },
                        dataType: 'json',
                        success: function (response) {
                            // remove file from an array
                            files = jQuery.grep(files, function (file) {
                                return file.name != filename;
                            });

                            updateFileData();

                            $this.closest("td").closest("tr").remove();
                        },
                        error: function (response) {
                            alert(response.error);
                        }
                    });
                }
            } else {
                // remove file from an array
                files = jQuery.grep(files, function (file) {
                    return file.name != filename;
                });

                updateFileData();

                $this.closest("td").closest("tr").remove();
            }


        });

        $('#fileupload').fileupload({
            url: url,
            dataType: 'json',
            autoUpload: true,
            acceptFileTypes: /(\.|\/)(ai|eps|pdf|svg|docx?|gif|jpe?g|png|gif|zip|rar)$/i,
            maxFileSize: 2250000,
            // Enable image resizing, except for Android and Opera,
            // which actually support image resizing, but fail to
            // send Blob objects via XHR requests:
            disableImageResize: /Android(?!.*Chrome)|Opera/
                .test(window.navigator.userAgent),
            previewMaxWidth: 100,
            previewMaxHeight: 100,
            previewCrop: true,
        }).on('fileuploadadd', function (e, data) {

            // reset progress bar
            $('#progress .progress-bar').css('width', 0);

            data.context = $('<div/>').appendTo('#files');

        }).on('fileuploadprocessalways', function (e, data) {
            var index = data.index,
                file = data.files[index],
                node = $(data.context.children()[index]);
            if (file.preview) {
                node
                    .prepend('<br>')
                    .prepend(file.preview);
            }
            if (file.error) {
                alert(file.error);
                node
                    .append('<br>')
                    .append($('<span class="text-danger"/>').text(file.error));
            }
            if (index + 1 === data.files.length) {
                data.context.find('button')
                    .text('Upload')
                    .prop('disabled', !!data.files.error);
            }
        }).on('fileuploadprogressall', function (e, data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css(
                'width',
                progress + '%'
            );
        }).on('fileuploaddone', function (e, data) {
            $.each(data.result.files, function (index, file) {
                if (file.url) {
                    console.log(file);
                    // variable to check file is image or not will use for showing thumb preview
                    var is_image = file.type.split('/')[0] == 'image';
                    var image = is_image ? file.url : "{{no_image_ur}}";

                    // file size
                    var sizeinbytes = file.size;
                    var file_size_types = new Array('Bytes', 'KB', 'MB', 'GB');
                    var fSize = sizeinbytes;
                    var i = 0;
                    while (fSize > 900){fSize/=1024;i++;}
                        fSize = ((Math.round(fSize * 100) / 100) + ' ' + file_size_types[i]);

                    // var get extention
                    var file_extention = file.name.substr((file.name.lastIndexOf('.') + 1)).toUpperCase();

                    var link = $('<a>')
                        .attr('target', '_blank')
                        .prop('href', file.url)
                        .text(file.name);
                    files.push(file);

                    updateFileData();

                    var row = "<tr><td><a href='" + image + "' rel='attachment' class='attachment_image_link'><img src='" + image + "' width='80'/></a></td><td>" + file.name + "</td><td>" + file_extention + "</td><td>" + fSize + "</td><td><a class='download' href='" + file.url + "'><i class='fa fa-download btn-download' aria-hidden='true'></i></a> | <a class='remove' href='javascript:void(0)' data-filetype='temp' data-filename='" + file.name + "'><i class='fa fa-trash btn-delete' aria-hidden='true'></i></a></td></tr>";
                    $("#fileuploadbox #files-table > tbody").append(row);
                } else if (file.error) {
                    alert(file.error);
                    var error = $('<span class="text-danger"/>').text(file.error);
                    $(data.context.children()[index])
                        .append('<br>')
                        .append(error);
                }
            });
        }).on('fileuploadfail', function (e, data) {
            $.each(data.files, function (index) {
                var error = $('<span class="text-danger"/>').text('File upload failed.');
                $(data.context.children()[index])
                    .append('<br>')
                    .append(error);
            });
        }).prop('disabled', !$.support.fileInput)
            .parent().addClass($.support.fileInput ? undefined : 'disabled');

        var loadFiles = function () {
            $.each(files, function (index, file) {
                // variable to check file is image or not will use for showing thumb preview
                var is_image = file.type.split('/')[0] == 'image';
                var image = is_image ? file.fileurl : "{{no_image_ur}}";

                // file size
                var sizeinbytes = file.size;
                var file_size_types = new Array('Bytes', 'KB', 'MB', 'GB');
                var fSize = sizeinbytes;
                var i = 0;
                while (fSize > 900){fSize/=1024;i++;}
                    fSize = ((Math.round(fSize * 100) / 100) + ' ' + file_size_types[i]);

                // var get extention
                var file_extention = file.original_name.substr((file.original_name.lastIndexOf('.') + 1)).toUpperCase();

                var row = "<tr><td><a href='" + image + "' rel='attachment' class='attachment_image_link'><img src='" + image + "' width='80'/></a></td><td>" + file.original_name + "</td><td>" + file_extention + "</td><td>" + fSize + "</td><td><a class='download' href='" + file.url + "'><i class='fa fa-download btn-download' aria-hidden='true'></i></a> | <a class='remove' href='javascript:void(0)' data-filetype='' data-filename='" + file.name + "'><i class='fa fa-trash btn-delete' aria-hidden='true'></i></a></td></tr>";
                $("#fileuploadbox #files-table > tbody").append(row);
            });

        }

        // load values in file array on load
        loadFiles();

	});

	jQuery(document).ready(function ($) {
        $(document).delegate(".attachment_image_link", "click", function (e) {
            $.colorbox.remove();
            $.colorbox({
                href: $(this).attr('href'),
                open: true,
                rel: 'attachment',
                transition: "fade",
                photo: true
            });
            return false;
        });

		if($('input[name=\'quotation_id\']').val()){
			var total_shipping = $('option:selected', $('#input-shipping-method')).attr('total');
			var cost_shipping = $('option:selected', $('#input-shipping-method')).attr('cost');
			var tax_ship = parseFloat(parseFloat(total_shipping) - parseFloat(cost_shipping)).toFixed(2);
			$('#shipping_tax').val(tax_ship);
		}
		$('#input-shipping-method').on('change',function(){
			var cost = $('option:selected', this).attr('cost');
			var tax_rate = $('option:selected', this).attr('tax');
			var total_cost = $('option:selected', this).attr('total');
			var tax_cost = 0;
			var shipping_cost = $('.shipping_cost').val();
			var shipping_tax = $('#shipping_tax').val();
			if(shipping_cost == ''){
				shipping_cost = 0;
			}
			if(cost != 0){
				$('#shipping_cost').html(cost);
				$('.shipping_cost').attr('value',cost);
				tax_cost = total_cost-cost;
			}else{
				$('#shipping_cost').html('0.00');
				$('.shipping_cost').attr('value','0.00');
				cost = 0.00;
			}
			var total = $('.total').val();
			var tax = $('.tax').val(); 

			if(tax != ''){
				var tax_added = parseFloat(parseFloat(tax.replace(",","")) - parseFloat(shipping_tax) + parseFloat(tax_cost)).toFixed(2);
			}else{
				var tax_added = parseFloat(tax_cost).toFixed(2);
			}
			var shipping_added = parseFloat(parseFloat(total.replace(",","")) - parseFloat(shipping_cost) - parseFloat(shipping_tax) + parseFloat(total_cost)).toFixed(2);
			if(total != ''){
				$('#total').html(numberWithCommas(shipping_added));
				$('.total').val(shipping_added);
			}else{
				$('#total').html(numberWithCommas(total_cost));
				$('.total').val(total_cost);
			}

			$('#tax').html(numberWithCommas(tax_added));
			$('.tax').attr('value',tax_added)
			$('#shipping_tax').attr('value',tax_cost);
		});

    });

</script>

<!-- file upload -->
<script type="text/javascript">
$('#accountdetails').trigger('click');
  var rearrange_rows = function(){
    $(document).find("[id^=article_nr]").each(function () {
      var row_id = $(this).closest("tr").attr("id").replace("article_row","");
      var index = $(this).closest("tr").index();
      if(index > 0){
        index = index / 2;
      }
      $(this).closest("tr").find(".sort_order").val(index);

    });
};
  
rearrange_rows();

$(document).ready(function(){
	$('#article').rowSorter({
      handler: 'i.sorter',
      onDrop: function(tbody, row, new_index, old_index){
        rearrange_rows();
      }
    });
    $('#addEmptyRow').trigger('click');
});

$(document).on("input propertychange paste", "[id^=quantity]", function () {
    var quantity_field = $(this);
    var row_id = $(this).attr("id").replace("quantity", "");
    var product_id = $("#productrow" + row_id).val();

    if (product_id) {
       displayRes(product_id, 'article_nr' + row_id);
    }
});

    function displayRes(productid, row) {
        var fields = row.split('article_nr');
        var rowspos = fields[1];
		//v4
		var customer_id = $("#customer_id").val();
		var quantity = $("#quantity" + rowspos).val();
		 //v4
        $.ajax({
            url: 'index.php?route=codevoc/b2bmanager_order.loadproduct&user_token={{ user_token }}&product_id=' + productid+'&customer_id=' + customer_id + '&quantity=' + quantity,
            dataType: 'json',
            type: 'post',
            success: function (json) {
                if (json['success']) {
					var pricem = json['price'];
					pricem = parseFloat(pricem).toFixed(2);
                    $('#price' + rowspos).val(pricem);
					$('#total_tax' + rowspos).val(json['total_tax']);

					//discount price calculation
					var oprice = json['oprice'];
					oprice = parseFloat(oprice).toFixed(2);
					$('#oprice' + rowspos).val(oprice);
                    $('#oprice' + rowspos).attr('value',oprice);
					$('#oprice_v' + rowspos).val(oprice);
					var pricediscount_percentage=json['price_discount_percentage'];
					if(pricediscount_percentage>0){
						pricediscount_percentage = parseFloat(pricediscount_percentage).toFixed(2);
						$('#price_discount_percentage' + rowspos).val(pricediscount_percentage);
					}else{
						$('#price_discount_percentage' + rowspos).val(pricediscount_percentage);
					}
					//discount price calculation

					//v5
					 $('#pprice' + rowspos).val(pricem);
					$('#pprice' + rowspos).attr('value',pricem);
					//v5
					  pricecal();
					// build select options and add options only when if it's not loaded first time
					if($('#options' + rowspos).find('select').length <= 0 || $('#options' + rowspos).find('select')[0].name != 'order_products['+ rowspos + '][option]['+json['options'][0].product_option_id+']')
                    {
                      var options_string = "";

                      if (json['options'].length > 0) {
                          var counter_row=0;
						  $.each(json['options'], function (i, v) {
                              if (v.type == "select") {
								  options_string += '<input type="hidden" id="optionprice' + rowspos + '_' + counter_row + '">';
                                  options_string += '<select class="form-select form-select-sm" id="optiondropdown' + rowspos + '_' + counter_row + '" onChange="oppricecal('+rowspos+','+counter_row+');" name="order_products[' + rowspos + '][option][' + v.product_option_id + ']" id="input-option' + v.product_option_id + '" class="options-list">';
                                  options_string += "<option value=''>" + v.name + "</option>";
                                  $.each(v.product_option_value, function (op_i, op_v) {
                                      options_string += "<option value='" + op_v.product_option_value_id + "'>" + op_v.name + "</option>";
                                  });
                                  options_string += "</select>";
								counter_row=counter_row+1;
							  }
                          });
                      } else {
                          options_string += "<input type='hidden' name='order_products[" + rowspos + "][product_option][]' value=''><span>No options are available.</span>";
                      }
                      $('#options' + rowspos).html(options_string);
					}

					// build select options and add options only when if it's not loaded first time
					if($('#tax_classes' + rowspos).find('select').length <= 0){
                            {% for tax_class in tax_classes %}
							  if(json['tax_class_id']=={{tax_class.tax_class_id}})
							  {
								$('input[name=\'order_products[' + rowspos +'][tax_class_id]\']').val({{ tax_class.tax_class_id }});
							  }
							  else
							  {
								$('input[name=\'order_products[' + rowspos +'][tax_class_id]\']').val({{ tax_class.tax_class_id }});
							  }
							{% endfor %}

					}

                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
            }
        });
    }

	$(document).on('change', '.ctrl_quantity', function () {
        pricecal();
   	});

	$("[id^=article_nr]").each(function () {
        $(this).autocomplete({
            'source': function (request, response) {
                $.ajax({
                    url: 'index.php?route=codevoc/b2bmanager_order.productsautocomplete&user_token={{ user_token }}&filter_name=' + encodeURIComponent(request),
                    dataType: 'json',
                    success: function (json) {
                        response($.map(json, function (item) {
                            return {
							    label: item['name'],
                                value: item['product_id'],
                                product_name: item['product_name'],
                                model: item['model'],
                            }
                        }));
                    }
                });
            },
            'select': function (item) {
				var res = item['model'];
                $(this).val(res);
                res1 = item['product_name'];

                var pid = $(this).attr('id');
                var values = pid.split('article_nr');
                var countid = values[1];
                $('#productrow' + countid).val(item['value']);
                $('#productname' + countid).val(res1);
				displayRes(item['value'], this.id);
				calculateArticleTotals();
                addarticlerow();
            }
        });
    });

	$('#button-sync-details').on('click', function() {
		var customer_id = $(this).attr('value');
		$.ajax({
				url: 'index.php?route=customer/customer.getCustomer&user_token={{ user_token }}&customer_id=' + customer_id,
				type: 'post',
				dataType: 'json',
				crossDomain: true,
				success: function(json) {
					$("#customer_company").val(json[0].custom_field[$('#custom_field_id_forerag').val()].replace("&amp;","&"));
					$("#vatnr").val(json[0].custom_field[$('#custom_field_id_vatnr').val()].replace("&amp;","&"));
					$("#input-firstname").val(json[0].firstname);
					$("#input-lastname").val(json[0].lastname);
					$("#input-email").val(json[0].email);
					$("#input-telephone").val(json[0].telephone);
					$("#customer_company").attr('value',json[0].custom_field[$('#custom_field_id_forerag').val()].replace("&amp;","&"));
					$("#vatnr").attr('value',json[0].custom_field[$('#custom_field_id_vatnr').val()].replace("&amp;","&"));
					$("#input-firstname").attr('value',json[0].firstname);
					$("#input-lastname").attr('value',json[0].lastname);
					$("#input-email").attr('value',json[0].email);
					$("#input-telephone").attr('value',json[0].telephone);
						
					if (json['error']) {
						console.log(json);
					}
					else
					{
					   $('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Customer details synced successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
					}
				},
				error: function(xhr, ajaxOptions, thrownError) {
					alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
				}
			});
	});

	$('#button-save-details').on('click', function() {
			var customer_id = $(this).attr('value');
			var firstname = $("#input-firstname").val();
			var lastname = $("#input-lastname").val();
			var forerag = $("#customer_company").val();
			var vatnr = $("#vatnr").val();
			var custom_field_id_vatnr = $("#custom_field_id_vatnr").val();
			var custom_field_id_forerag = $("#custom_field_id_forerag").val();
			var email = $("#input-email").val();
			var telephone = $("#input-telephone").val();
			$.post({
				url: 'index.php?route=customer/customer.updateNewDetails&user_token={{ user_token }}&customer_id=' + customer_id,
				type: 'post',
				data:{
					customer_id : customer_id,
					firstname : firstname,
					lastname : lastname,
					forerag: forerag,
					vatnr: vatnr,
					custom_field_id_vatnr: custom_field_id_vatnr,
					custom_field_id_forerag: custom_field_id_forerag,
					email : email,
					telephone : telephone
				},
				dataType: 'json',
				crossDomain: true,
				success: function() {
					$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Customer details updated successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
			},
				error: function(xhr, ajaxOptions, thrownError) {
					alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
				}
			});
	});

	$('#input-customer').autocomplete({
			'source': function(request, response) {
					$.ajax({
						url: 'index.php?route=customer/customer.autocomplete&user_token={{ user_token }}&filter_search=' +  encodeURIComponent(request),
						dataType: 'json',
						success: function(json) {
						json.unshift({
								customer_id: '0',
								customer_group_id: '{{ customer_group_id }}',
								name: '{{ text_none }}',
								customer_group: '',
								firstname: '',
								lastname: '',
								email: '',
								telephone: '',
								company: '',
								address: []
						});
				
					response($.map(json, function(item) {
						return {
								category: item['customer_group'],
								label: item['name'],
								value: item['customer_id'],
								customer_group_id: item['customer_group_id'],
								firstname: item['firstname'],
								lastname: item['lastname'],
								email: item['email'],
								telephone: item['telephone'],
								company: item['company'],
								address: item['address']
							}
					}));
					
				}
			});
		},
		'select': function(item) {
			// Reset all custom fields
			$('#account-details input[type=\'text\'], #account-details textarea').not('#account-details input[name=\'customer\'], #account-details input[name=\'customer_id\']').val('');
			$('#account-details select option').not($('#account-details select[name=\'store_id\'] option, #account-details select[name=\'currency\'] option')).removeAttr('selected');
			$('#account-details input[type=\'checkbox\'], #account-details input[type=\'radio\']').removeAttr('checked');
			if(item['custom_field']){
                $('#customer_company').val(item['custom_field'][$('#custom_field_id_forerag').val()].replace('&amp;','&'));
                $('#customer_company').attr('value',item['custom_field'][$('#custom_field_id_forerag').val()].replace('&amp;','&'));
				$('#vatnr').val(item['custom_field'][$('#custom_field_id_vatnr').val()].replace('&amp;','&'));
                $('#vatnr').attr('value',item['custom_field'][$('#custom_field_id_vatnr').val()].replace('&amp;','&'));
            }else{
                $('#customer_company').val(item['custom_field'][$('#custom_field_id_forerag').val()]);
                $('#customer_company').attr('value',item['custom_field'][$('#custom_field_id_forerag').val()]);
				$('#vatnr').val(item['custom_field'][$('#custom_field_id_vatnr').val()]);
                $('#vatnr').attr('value',item['custom_field'][$('#custom_field_id_vatnr').val()]);
            }
			$('.editCustomer').attr("href", "index.php?route=customer/customer.form&user_token={{ user_token }}&customer_id="+item['value']);
			$('.editCustomer').attr("target", "_blank");
			$('.editCustomer').removeClass("disabled");
			$('.button-sync-details').attr("value", item['value']);
			$('.button-save-details').attr("value", item['value']);
			$('.button-sync-details').removeClass("disabled");
			$('.button-save-details').removeClass("disabled");
			$('#account-details input[name=\'customer\']').val(item['label']);
			$('#account-details input[name=\'customer_id\']').val(item['value']);
			$('#account-details input[name=\'input_firstname\']').val(item['firstname']);
			$('#account-details input[name=\'input_lastname\']').val(item['lastname']);
			$('#account-details input[name=\'email\']').val(item['email']);
			$('#account-details input[name=\'telephone\']').val(item['telephone']);
			$('#account-details input[name=\'customer\']').attr('value',item['label']);
			$('#account-details input[name=\'customer_id\']').attr('value',item['value']);
			$('#account-details input[name=\'input_firstname\']').attr('value',item['firstname']);
			$('#account-details input[name=\'input_lastname\']').attr('value',item['lastname']);
			$('#account-details input[name=\'email\']').attr('value',item['email']);
			$('#account-details input[name=\'telephone\']').attr('value',item['telephone']);
					
			for (i in item.custom_field) {
				$('#account-details select[name=\'custom_field[' + i + ']\']').val(item.custom_field[i]);
				$('#account-details textarea[name=\'custom_field[' + i + ']\']').val(item.custom_field[i]);
				$('#account-details input[name^=\'custom_field[' + i + ']\'][type=\'text\']').val(item.custom_field[i]);
				$('#account-details input[name^=\'custom_field[' + i + ']\'][type=\'hidden\']').val(item.custom_field[i]);
				$('#account-details input[name^=\'custom_field[' + i + ']\'][type=\'radio\'][value=\'' + item.custom_field[i] + '\']').prop('checked', true);
			
				if (item.custom_field[i] instanceof Array) {
					for (j = 0; j < item.custom_field[i].length; j++) {
						$('#account-details input[name^=\'custom_field[' + i + ']\'][type=\'checkbox\'][value=\'' + item.custom_field[i][j] + '\']').prop('checked', true);
					}
				}
			}
			
			
			html = '<option value="0">{{ text_none }}</option>';
					
			for (i in  item['address']) {
				html += '<option value="' + item['address'][i]['address_id'] + '">' + item['address'][i]['firstname'] + ' ' + item['address'][i]['lastname'] + ', ' + item['address'][i]['address_1'] + ', ' + item['address'][i]['city'] + ', ' + item['address'][i]['country'] + '</option>';
			}
					
			$('select[name=\'payment_address\']').html(html);
			$('select[name=\'shipping_address\']').html(html);
				
			/* save customer session step 1 */
		}
	});

	//var totalrow = $('#totalrow').attr('name').match(/\d+/)[0];

	$('select[name=\'payment_address\']').on('change', function() {
		if($('#input-payment-address').val()){
			url = 'index.php?route=customer/customer.address&user_token={{ user_token }}&address_id=' + $('#input-payment-address').val();
		}else{
			url = 'index.php?route=customer/customer.address&user_token={{ user_token }}&address_id=' + this.value;
		}
	$.ajax({
		url: url,
		dataType: 'json',
		beforeSend: function() {
			$('select[name=\'payment_address\']').prop('disabled', true);
		},
		complete: function() {
			$('select[name=\'payment_address\']').prop('disabled', false);
		},
		success: function(json) {
			// Reset all fields
			if(json['address_id']){
				$('#savePaymentAddress').attr('value',json['address_id']);
				$('#savePaymentAddress').removeClass('disabled');
				$('#syncPaymentAddress').removeClass('disabled');
				$('#syncPaymentAddress').attr('value',json['address_id']);
			}
			if($('#input-payment-address').val()==0){
				$('#savePaymentNewAddress').removeClass('disabled');
				$('#savePaymentAddress').addClass('disabled');
			}else{
				$('#savePaymentNewAddress').addClass('disabled');
				$('#savePaymentAddress').removeClass('disabled');
			}
			$('#payment-details input[type=\'text\'], #payment-details input[type=\'text\'], #payment-details textarea').val('');
			$('#payment-details select option').not('#payment-details select[name=\'payment_address\']').removeAttr('selected');
			$('#payment-details select[name=\'payment_address\'] ').val(json['address_id']);
			$('#payment-details input[name=\'input_payment_firstname\']').val(json['firstname']);
			$('#payment-details input[name=\'input_payment_lastname\']').val(json['lastname']);
			$('#payment-details input[name=\'input_payment_company\']').val(json['company']);
			$('#payment-details input[name=\'input_payment_address_1\']').val(json['address_1']);
			$('#payment-details input[name=\'input_payment_address_2\']').val(json['address_2']);
			$('#payment-details input[name=\'input_payment_city\']').val(json['city']);
			$('#payment-details input[name=\'input_payment_postcode\']').val(json['postcode']);
			$('#payment-details select[name=\'input_payment_country_id\']').val(json['country_id']);
			$('#payment-details input[name=\'input_payment_firstname\']').attr('value',json['firstname']);
			$('#payment-details input[name=\'input_payment_lastname\']').attr('value',json['lastname']);
			$('#payment-details input[name=\'input_payment_company\']').attr('value',json['company']);
			$('#payment-details input[name=\'input_payment_address_1\']').attr('value',json['address_1']);
			$('#payment-details input[name=\'input_payment_address_2\']').attr('value',json['address_2']);
			$('#payment-details input[name=\'input_payment_city\']').attr('value',json['city']);
			$('#payment-details input[name=\'input_payment_postcode\']').attr('value',json['postcode']);
			$('#payment-details select[name=\'input_payment_country_id\']').attr('value',json['country_id']);
			payment_zone_id = json['zone_id'];

			for (i in json['custom_field']) {
				$('#payment-details select[name=\'custom_field[' + i + ']\']').val(json['custom_field'][i]);
				$('#payment-details textarea[name=\'custom_field[' + i + ']\']').val(json['custom_field'][i]);
				$('#payment-details input[name^=\'custom_field[' + i + ']\'][type=\'text\']').val(json['custom_field'][i]);
				$('#payment-details input[name^=\'custom_field[' + i + ']\'][type=\'hidden\']').val(json['custom_field'][i]);
				$('#payment-details input[name^=\'custom_field[' + i + ']\'][type=\'radio\'][value=\'' + json['custom_field'][i] + '\']').prop('checked', true);
				$('#payment-details input[name^=\'custom_field[' + i + ']\'][type=\'checkbox\'][value=\'' + json['custom_field'][i] + '\']').prop('checked', true);

				if (json['custom_field'][i] instanceof Array) {
					for (j = 0; j < json['custom_field'][i].length; j++) {
						$('#payment-details input[name^=\'custom_field[' + i + ']\'][type=\'checkbox\'][value=\'' + json['custom_field'][i][j] + '\']').prop('checked', true);
					}
				}
			}

			$('#payment-details select[name=\'input_payment_country_id\']').trigger('change');

		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
		});
	});

	$('#payment-details select[name=\'input_payment_country_id\']').on('change', function() {
	$.ajax({
		url: 'index.php?route=localisation/country.country&user_token={{ user_token }}&country_id=' + this.value,
		dataType: 'json',
		beforeSend: function() {
			$('#payment-details select[name=\'input_payment_country_id\']').after('');
		},
		complete: function() {
			$('#payment-details .fa-spin').remove();
		},
		success: function(json) {
			if (json['postcode_required'] == '1') {
				$('#payment-details input[name=\'input_payment_postcode\']').closest('.form-group').addClass('required');
			} else {
				$('#payment-details input[name=\'input_payment_postcode\']').closest('.form-group').removeClass('required');
			}

			html = '<option value="">{{ text_select }}</option>';

			if (json['zone'] && json['zone'] != '') {
				for (i = 0; i < json['zone'].length; i++) {
        			html += '<option value="' + json['zone'][i]['zone_id'] + '"';

					if (json['zone'][i]['zone_id'] == payment_zone_id) {
	      				html += ' selected="selected"';
	    			}

	    			html += '>' + json['zone'][i]['name'] + '</option>';
				}
			} else {
				html += '<option value="0" selected="selected">{{ text_none }}</option>';
			}

			$('#payment-details select[name=\'input_payment_zone_id\']').html(html);
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
	});

	$('select[name=\'shipping_address\']').on('change', function() {
		if($('#shipping_address_id').val()){
			$url = 'index.php?route=customer/customer.address&user_token={{ user_token }}&address_id=' + $('#shipping_address_id').val();
		}else{
			$url = 'index.php?route=customer/customer.address&user_token={{ user_token }}&address_id=' + this.value;
		}
	$.ajax({
		url: $url,
		dataType: 'json',
		beforeSend: function() {
			$('select[name=\'shipping_address\']').prop('disabled', true);
		},
		complete: function() {
			$('select[name=\'shipping_address\']').prop('disabled', false);
		},
		success: function(json) {
			// Reset all fields
			if(json['address_id']){
				$('#saveShippingAddress').attr('value',json['address_id']);
				$('#saveShippingAddress').removeClass('disabled');
				$('#syncShippingAddress').removeClass('disabled');
				$('#syncShippingAddress').attr('value',json['address_id']);
			}
			if($('#input-shipping-address').val()==0){
				$('#saveShippingNewAddress').removeClass('disabled');
				$('#saveShippingAddress').addClass('disabled');
			}else{
				$('#saveShippingNewAddress').addClass('disabled');
				$('#saveShippingAddress').removeClass('disabled');
			}
			$('#shipping-details input[type=\'text\'], #shipping-details input[type=\'text\'], #shipping-details textarea').val('');
			$('#shipping-details select option').not('#shipping-details select[name=\'shipping_address\']').removeAttr('selected');
			$('select[name=\'shipping_address\']').val(json['address_id']);
			$('#shipping-details input[name=\'input_shipping_firstname\']').val(json['firstname']);
			$('#shipping-details input[name=\'input_shipping_lastname\']').val(json['lastname']);
			$('#shipping-details input[name=\'input_shipping_company\']').val(json['company']);
			$('#shipping-details input[name=\'input_shipping_address_1\']').val(json['address_1']);
			$('#shipping-details input[name=\'input_shipping_address_2\']').val(json['address_2']);
			$('#shipping-details input[name=\'input_shipping_city\']').val(json['city']);
			$('#shipping-details input[name=\'input_shipping_postcode\']').val(json['postcode']);
			$('#shipping-details select[name=\'input_shipping_country_id\']').val(json['country_id']);
			$('#shipping-details input[name=\'input_shipping_firstname\']').attr('value',json['firstname']);
			$('#shipping-details input[name=\'input_shipping_lastname\']').attr('value',json['lastname']);
			$('#shipping-details input[name=\'input_shipping_company\']').attr('value',json['company']);
			$('#shipping-details input[name=\'input_shipping_address_1\']').attr('value',json['address_1']);
			$('#shipping-details input[name=\'input_shipping_address_2\']').attr('value',json['address_2']);
			$('#shipping-details input[name=\'input_shipping_city\']').attr('value',json['city']);
			$('#shipping-details input[name=\'input_shipping_postcode\']').attr('value',json['postcode']);
			$('#shipping-details select[name=\'input_shipping_country_id\']').attr('value',json['country_id']);

			shipping_zone_id = json['zone_id'];

			for (i in json['custom_field']) {
				$('#shipping-details select[name=\'custom_field[' + i + ']\']').val(json['custom_field'][i]);
				$('#shipping-details textarea[name=\'custom_field[' + i + ']\']').val(json['custom_field'][i]);
				$('#shipping-details input[name^=\'custom_field[' + i + ']\'][type=\'text\']').val(json['custom_field'][i]);
				$('#shipping-details input[name^=\'custom_field[' + i + ']\'][type=\'hidden\']').val(json['custom_field'][i]);
				$('#shipping-details input[name^=\'custom_field[' + i + ']\'][type=\'radio\'][value=\'' + json['custom_field'][i] + '\']').prop('checked', true);
				$('#shipping-details input[name^=\'custom_field[' + i + ']\'][type=\'checkbox\'][value=\'' + json['custom_field'][i] + '\']').prop('checked', true);

				if (json['custom_field'][i] instanceof Array) {
					for (j = 0; j < json['custom_field'][i].length; j++) {
						$('#shipping-details input[name^=\'custom_field[' + i + ']\'][type=\'checkbox\'][value=\'' + json['custom_field'][i][j] + '\']').prop('checked', true);
					}
				}
			}

			$('#shipping-details select[name=\'input_shipping_country_id\']').trigger('change');
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
	});

	
    $('#shipping-details select[name=\'input_shipping_country_id\']').on('change', function() {
	$.ajax({
		url: 'index.php?route=localisation/country.country&user_token={{ user_token }}&country_id=' + this.value,
		dataType: 'json',
		beforeSend: function() {
			$('#shipping-details select[name=\'input_shipping_country_id\']').prop('disabled', true);
		},
		complete: function() {
			$('#shipping-details select[name=\'input_shipping_country_id\']').prop('disabled', false);
		},
		success: function(json) {
			if (json['postcode_required'] == '1') {
				$('#shipping-details input[name=\'input_shipping_postcode\']').closest('.form-group').addClass('required');
			} else {
				$('#shipping-details input[name=\'input_shipping_postcode\']').closest('.form-group').removeClass('required');
			}

			html = '<option value="">{{ text_select }}</option>';

			if (json['zone'] && json['zone'] != '') {
				for (i = 0; i < json['zone'].length; i++) {
        			html += '<option value="' + json['zone'][i]['zone_id'] + '"';

					if (json['zone'][i]['zone_id'] == shipping_zone_id) {
	      				html += ' selected="selected"';
	    			}

	    			html += '>' + json['zone'][i]['name'] + '</option>';
				}
			} else {
				html += '<option value="0" selected="selected">{{ text_none }}</option>';
			}

			$('#shipping-details select[name=\'input_shipping_zone_id\']').html(html);
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
	});

	function saveOrder(){
		var buttontype=$('#buttontype').val();
		if($('input[name=\'order_status_id\']').val()=='')
		{
			alert("Ange offert status");
		}
		else{
			if ($('input[name=\'order_id\']').val() == 0) {
				var url = 'index.php?route=codevoc/b2bmanager_quotation.addQuotation&user_token={{ user_token }}';
			} else {
				var url = 'index.php?route=codevoc/b2bmanager_order.editOrder&user_token={{ user_token }}'+ '&order_id=' + $('input[name=\'order_id\']').val();
			}
		
			$.ajax({
				url: url,
				type: 'post',
				data: $('#form-product').serialize(),
				dataType: 'json',
				crossDomain: true,
				success: function(json) {
					$('.alert-dismissible, .text-danger').remove();
		
					if (json['error']) {
						$('#alert').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
					}
			
					if (json['order_id']) {
						$('input[name=\'order_id\']').val(json['order_id']);
						$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Quotation Created Successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
							window.location='{{cancel}}';
					}else if(json['order_id']==null){
						if(confirm('Do you want to send the mail to customer?')){
							$.ajax({
								url : 'index.php?route=codevoc/b2bmanager_order.sendUpdateMail&user_token={{ user_token }}'+ '&order_id=' + $('input[name=\'order_id\']').val(),
								type : 'post',
								dataType:'html'
							})
						}
						$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Order Updated Successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
					}
					var sendmail_delivery = false
					var order_status_id = $('#order_status_id').val()
					if(order_status_id == 5){
							if(confirm("Vill du skicka leveransbekräftelse? Om lagerupphämtning välj avbryt/cancel = inget mail skickas.")) {
									sendmail_delivery = true
							}
					}
					if(sendmail_delivery) {
							$.ajax({
									url: 'index.php?route=codevoc/b2bmanager_order.sendmail_delivery&user_token={{ user_token }}&order_id={{ order_id }}&email={{ email }}',
									type: 'post',
									dataType: 'html',
							});
					}
			
				},
				error: function(xhr, ajaxOptions, thrownError) {
					alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
				}
			});
		}
	}	

	function removerow() {
        var totalrow = $('#totalrow').val();
        totalrow = totalrow - 1;
        $('#totalrow').val(totalrow);
    }	

$('#savePaymentAddress').on('click',function(){
	var address_id = $(this).attr('value');
	var firstname = $('#input-payment-firstname').val();
	var lastname = $("#input-payment-lastname").val();
	var company = $("#input-payment-company").val();
	var address_1 = $("#input-payment-address-1").val();
	var address_2 = $("#input-payment-address-2").val();
	var postcode = $("#input-payment-postcode").val();
	var city = $("#input-payment-city").val();
	var country_id = $("#input-payment-country").val();
	var zone_id = $("#input-payment-zone").val();
	$.ajax({
		url: 'index.php?route=customer/customer.address&user_token={{ user_token }}&address_id='+address_id,
		type: 'post',
		data:{},
		dataType: '',
		crossDomain: true,
		success: function(jsonData) {
			var firstname_before = jsonData['firstname'];
			var lastname_before = jsonData['lastname'];
			var company_before = jsonData['company'];
			var address_1_before = jsonData['address_1'];
			var address_2_before = jsonData['address_2'];
			var postcode_before = jsonData['postcode'];
			var city_before = jsonData['city'];
			var country_id_before = jsonData['country_id'];
			var zone_id_before = jsonData['zone_id'];

				$.ajax({
					url: 'index.php?route=customer/customer.updateAddressById&user_token={{ user_token }}',
					type: 'post',
					data:{
						address_id : address_id,
						firstname : firstname,
						lastname : lastname,
						company : company,
						address_1 : address_1,
						address_2 : address_2,
						postcode : postcode,
						city : city,
						country_id : country_id,
						zone_id : zone_id,
					},
					dataType: '',
					crossDomain: true,
					success: function() {
						
						$('#input-payment-firstname').val(firstname_before);
						$('#input-payment-firstname').attr('value',firstname_before);
						$('#input-payment-lastname').val(lastname_before);
						$('#input-payment-lastname').attr('value',lastname_before);
						$('#input-payment-company').val(company_before);
						$('#input-payment-company').attr('value',company_before);
						$('#input-payment-address-1').val(address_1_before);
						$('#input-payment-address-1').attr('value',address_1_before);
						$('#input-payment-address-2').val(address_2_before);
						$('#input-payment-address-2').attr('value',address_2_before);
						$('#input-payment-postcode').val(postcode_before);
						$('#input-payment-postcode').attr('value',postcode_before);
						$('#input-payment-city').val(city_before);
						$('#input-payment-city').attr('value',city_before);
						$('#input-payment-country').val(country_id_before);
						$('#input-payment-country').attr('value',country_id_before);
						payment_zone_id = zone_id_before;
						$('#payment-details select[name=\'input_payment_country_id\']').trigger('change');
						$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Address Updated Successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
				},
					error: function(xhr, ajaxOptions, thrownError) {
						alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					}
				});

		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
});

$('#saveShippingAddress').on('click',function(){
	var address_id = $(this).attr('value');
	var firstname = $('#input-shipping-firstname').val();
	var lastname = $("#input-shipping-lastname").val();
	var company = $("#input-shipping-company").val();
	var address_1 = $("#input-shipping-address-1").val();
	var address_2 = $("#input-shipping-address-2").val();
	var postcode = $("#input-shipping-postcode").val();
	var city = $("#input-shipping-city").val();
	var country_id = $("#input-shipping-country").val();
	var zone_id = $("#input-shipping-zone").val();
	$.ajax({
		url: 'index.php?route=customer/customer.address&user_token={{ user_token }}&address_id='+address_id,
		type: 'post',
		data:{},
		dataType: '',
		crossDomain: true,
		success: function(jsonData) {
			var firstname_before = jsonData['firstname'];
			var lastname_before = jsonData['lastname'];
			var company_before = jsonData['company'];
			var address_1_before = jsonData['address_1'];
			var address_2_before = jsonData['address_2'];
			var postcode_before = jsonData['postcode'];
			var city_before = jsonData['city'];
			var country_id_before = jsonData['country_id'];
			var zone_id_before = jsonData['zone_id'];

				$.ajax({
					url: 'index.php?route=customer/customer.updateAddressById&user_token={{ user_token }}',
					type: 'post',
					data:{
						address_id : address_id,
						firstname : firstname,
						lastname : lastname,
						company : company,
						address_1 : address_1,
						address_2 : address_2,
						postcode : postcode,
						city : city,
						country_id : country_id,
						zone_id : zone_id,
					},
					dataType: '',
					crossDomain: true,
					success: function() {
						
						$('#input-shipping-firstname').val(firstname_before);
						$('#input-shipping-firstname').attr('value',firstname_before);
						$('#input-shipping-lastname').val(lastname_before);
						$('#input-shipping-lastname').attr('value',lastname_before);
						$('#input-shipping-company').val(company_before);
						$('#input-shipping-company').attr('value',company_before);
						$('#input-shipping-address-1').val(address_1_before);
						$('#input-shipping-address-1').attr('value',address_1_before);
						$('#input-shipping-address-2').val(address_2_before);
						$('#input-shipping-address-2').attr('value',address_2_before);
						$('#input-shipping-postcode').val(postcode_before);
						$('#input-shipping-postcode').attr('value',postcode_before);
						$('#input-shipping-city').val(city_before);
						$('#input-shipping-city').attr('value',city_before);
						$('#input-shipping-country').val(country_id_before);
						$('#input-shipping-country').attr('value',country_id_before);
						shipping_zone_id = zone_id_before;
						$('#shipping-details select[name=\'input_shipping_country_id\']').trigger('change');
						$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Address Updated Successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');

				},
					error: function(xhr, ajaxOptions, thrownError) {
						alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					}
				});

		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
});

$('#savePaymentNewAddress').on('click',function(){
	var customer_id = $('#customer_id').val();
	if(customer_id == ''){
		alert('Please select customer first.');
	}else{
		var firstname = $('#input-payment-firstname').val();
		var lastname = $("#input-payment-lastname").val();
		var company = $("#input-payment-company").val();
		var address_1 = $("#input-payment-address-1").val();
		var address_2 = $("#input-payment-address-2").val();
		var postcode = $("#input-payment-postcode").val();
		var city = $("#input-payment-city").val();
		var country_id = $("#input-payment-country").val();
		var zone_id = $("#input-payment-zone").val();
		$.ajax({
			url: 'index.php?route=codevoc/b2bmanager_quotation.addAddress&user_token={{ user_token }}',
			type: 'post',
			data:{
				customer_id : customer_id,
				firstname : firstname,
				lastname : lastname,
				company : company,
				address_1 : address_1,
				address_2 : address_2,
				postcode : postcode,
				city : city,
				country_id : country_id,
				zone_id : zone_id,
			},
			success: function(json) {
				var html = '<option value="'+json['address_id']+'" selected="selected">'+json['firstname']+' '+json['lastname']+','+json['address_1']+','+json['city']+','+json['country']+'</option>';
				$('select[name=\'payment_address\']').append(html);
				$('#savePaymentNewAddress').addClass('disabled');
				$('#savePaymentAddress').removeClass('disabled');
				$('#savePaymentAddress').attr('value',json['address_id']);
				$('#syncPaymentAddress').removeClass('disabled');
				$('#syncPaymentAddress').attr('value',json['address_id']);
				$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Address Added Successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
			},
			error: function(xhr, ajaxOptions, thrownError) {
				alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			}
		});
	}
});

$('#saveShippingNewAddress').on('click',function(){
	var customer_id = $('#customer_id').val();
	if(customer_id != ''){
		var firstname = $('#input-shipping-firstname').val();
		var lastname = $("#input-shipping-lastname").val();
		var company = $("#input-shipping-company").val();
		var address_1 = $("#input-shipping-address-1").val();
		var address_2 = $("#input-shipping-address-2").val();
		var postcode = $("#input-shipping-postcode").val();
		var city = $("#input-shipping-city").val();
		var country_id = $("#input-shipping-country").val();
		var zone_id = $("#input-shipping-zone").val();
		$.ajax({
			url: 'index.php?route=codevoc/b2bmanager_quotation.addAddress&user_token={{ user_token }}',
			type: 'post',
			data:{
				customer_id : customer_id,
				firstname : firstname,
				lastname : lastname,
				company : company,
				address_1 : address_1,
				address_2 : address_2,
				postcode : postcode,
				city : city,
				country_id : country_id,
				zone_id : zone_id,
			},
			success: function(json) {
				var html = '<option value="'+json['address_id']+'" selected="selected">'+json['firstname']+' '+json['lastname']+','+json['address_1']+','+json['city']+','+json['country']+'</option>';
				$('select[name=\'shipping_address\']').append(html);
				$('#saveShippingNewAddress').addClass('disabled');
				$('#saveShippingAddress').removeClass('disabled');
				$('#saveShippingAddress').attr('value',json['address_id']);
				$('#syncShippingAddress').removeClass('disabled');
				$('#syncShippingAddress').attr('value',json['address_id']);
				$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Address Added Successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
			},
			error: function(xhr, ajaxOptions, thrownError) {
				alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			}
		});
	}else{
		alert('Please select customer first');
	}
});

$('#syncPaymentAddress').on('click',function(){
	var address_id = $(this).attr('value');
	$.ajax({
		url: 'index.php?route=customer/customer.address&user_token={{ user_token }}&address_id='+address_id,
		type: 'post',
		data:{},
		dataType: '',
		crossDomain: true,
		success: function(json) {
	   		if(confirm('Do you really want to sync new payment address?')){

					$('#input-payment-firstname').val(json['firstname']);
					$('#input-payment-firstname').attr('value',json['firstname']);
					$('#input-payment-lastname').val(json['lastname']);
					$('#input-payment-lastname').attr('value',json['lastname']);
					$('#input-payment-company').val(json['company']);
					$('#input-payment-company').attr('value',json['company']);
					$('#input-payment-address-1').val(json['address_1']);
					$('#input-payment-address-1').attr('value',json['address_1']);
					$('#input-payment-address-2').val(json['address_2']);
					$('#input-payment-address-2').attr('value',json['address_2']);
					$('#input-payment-postcode').val(json['postcode']);
					$('#input-payment-postcode').attr('value',json['postcode']);
					$('#input-payment-city').val(json['city']);
					$('#input-payment-city').attr('value',json['city']);
					$('#input-payment-country').val(json['country_id']);
					$('#input-payment-country').attr('value',json['country_id']);
					payment_zone_id = json['zone_id'];
					$('#payment-details select[name=\'input_payment_country_id\']').trigger('change');
					$('.alert-dismissible').remove();
					$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Payment address synced successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');

			}

	},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
});

$('#syncShippingAddress').on('click',function(){
	var address_id = $(this).attr('value');
	$.ajax({
		url: 'index.php?route=customer/customer.address&user_token={{ user_token }}&address_id='+address_id,
		type: 'post',
		data:{},
		dataType: '',
		crossDomain: true,
		success: function(json) {
	   		if(confirm('Do you really want to sync new shipping address?')){

					$('#input-shipping-firstname').val(json['firstname']);
					$('#input-shipping-firstname').attr('value',json['firstname']);
					$('#input-shipping-lastname').val(json['lastname']);
					$('#input-shipping-lastname').attr('value',json['lastname']);
					$('#input-shipping-company').val(json['company']);
					$('#input-shipping-company').attr('value',json['company']);
					$('#input-shipping-address-1').val(json['address_1']);
					$('#input-shipping-address-1').attr('value',json['address_1']);
					$('#input-shipping-address-2').val(json['address_2']);
					$('#input-shipping-address-2').attr('value',json['address_2']);
					$('#input-shipping-postcode').val(json['postcode']);
					$('#input-shipping-postcode').attr('value',json['postcode']);
					$('#input-shipping-city').val(json['city']);
					$('#input-shipping-city').attr('value',json['city']);
					$('#input-shipping-country').val(json['country_id']);
					$('#input-shipping-country').attr('value',json['country_id']);
					shipping_zone_id = json['zone_id'];
					$('#shipping-details select[name=\'input_shipping_country_id\']').trigger('change');
					$('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-check-circle"></i> Shipping address synced successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');

			}

	},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
});
//price calculation
function pricecal() {
        var totalrow = $('#totalrow').val();

        var subtotal = 0;
        var totalpay = 0;
		var total_tax = 0;		

        $('#article tbody tr').each(function () {
            var id = $(this).attr('id');

            var fields = id.split('article_row');
            var i = fields[1];
            if (i != null) {
				//v5
                var totalval = 0;
                var priceval = 0;
				var discountval = 0;
                var org_price = 0;
                //v5
				var article_nr = $('#article_nr'+i).val();
				if(article_nr != ''){
					var quantity = parseInt($('#quantity' + i).val());
					//v5
					var price = parseFloat($('#oprice_v' + i).val());
					//v5
					//discount price calculation
					var oprice = parseFloat($('#oprice_v' + i).val());
					//discount pirce calculation				
					var price_discount_percentage = parseFloat($('#price_discount_percentage' + i).val());
					if (price != '' && quantity != '') {
						priceval = parseFloat(price) * parseInt(quantity);
						totalval = priceval;
						//v5
							org_price=parseFloat(price);
						//v5
					}
					//discount price calculation
					if (priceval != '' && price_discount_percentage != '' ) {
						discountval = priceval * price_discount_percentage / 100;
						totalval = totalval - discountval;
						//discount price calculation
						var pp=oprice*price_discount_percentage/100;
						var disc=oprice-pp;
						org_price = parseFloat(disc);
							$('#price' + i).val(parseFloat(disc).toFixed(2));
							$('#price' + i).attr('value',parseFloat(disc).toFixed(2));	
							$('#pprice' + i).attr('value',parseFloat(disc).toFixed(2));	
						//discount price calculation			  
					}
					//get option price
						var optionprice=0;
						$('#options'+i+' input').each(function (){
							var opprice=$(this).val();
							if(opprice!='')
							{
									var oppriceArr = opprice.split("_");
									if(oppriceArr[0]=='-')
									{
										//v4
										optionprice=parseFloat(oppriceArr[1])*parseInt(quantity);
										totalval -=parseFloat(optionprice);
										//v4

										//v5
										org_price -=parseFloat(oppriceArr[1]);
										//v5

										//disount price calculation
										oprice -=parseFloat(oppriceArr[1]);
										//discount price calculation

									}
									else
									{
										//v4
										optionprice=parseFloat(oppriceArr[1])*parseInt(quantity);
										totalval +=parseFloat(optionprice);
										//v4

										//v5
										org_price +=parseFloat(oppriceArr[1]);
										//v5

										//disount price calculation
										oprice +=parseFloat(oppriceArr[1]);
										//discount price calculation


									}
								$('#price' + i).val(parseFloat(org_price).toFixed(2));
								$('#price' + i).attr('value',parseFloat(org_price).toFixed(2));
								$('#pprice' + i).attr('value',parseFloat(org_price).toFixed(2));
							}

						});
					//get option price
					//v5

					
					//v5
					//discount price calculation
					if(article_nr != ''){
						$('#oprice' + i).val(parseFloat(oprice).toFixed(2));
					}
					$('#total' + i).val(parseFloat(totalval).toFixed(2));
					totalvalue = totalval;
					tax_rate = $('#total_tax'+i).val();
					totalval = totalval + ((totalval*tax_rate)/100);
					subtotal = parseFloat(subtotal) + totalvalue ;
					total_tax_prod = parseFloat((totalvalue * tax_rate)/100);
					
					$('#total' + i).attr('value',parseFloat(totalvalue).toFixed(2));
					$('#total_tax_to_prod' + i).val(parseFloat(total_tax_prod).toFixed(2))
					totalpay = parseFloat(totalpay) + totalval;
					total_tax = parseFloat(totalpay) - parseFloat(subtotal);
				}
            }
        });



        var num = subtotal;
		subtotal = parseFloat(num).toFixed(2);
		
		var shipping = $('.shipping_cost').val();
		var shipping_tax = $('#shipping_tax').val();
		var num_total = totalpay;
		if(shipping){
			totalpay = (parseFloat(num_total) + parseFloat(shipping) + parseFloat(shipping_tax)).toFixed(2);
		}else{
			totalpay = parseFloat(num_total).toFixed(2);
		}

		if(shipping_tax){
			var num_tax = (parseFloat(total_tax) + parseFloat(shipping_tax)).toFixed(2);
		}else{
			var num_tax = total_tax;
		}
		
		total_tax = parseFloat(num_tax).toFixed(2);

		$('.sub_total').attr('value',subtotal);
        $('#sub_total').html(numberWithCommas(subtotal));
		$('.total').attr('value',totalpay);
        $('#total').html(numberWithCommas(totalpay));
		$('.tax').attr('value',total_tax);
		$('#tax').html(numberWithCommas(total_tax));

}		
//price calculation
function numberWithCommas(x) {
        x = String(x).toString();
        var afterPoint = '';
        if (x.indexOf('.') > 0)
            afterPoint = x.substring(x.indexOf('.'), x.length);
        x = Math.floor(x);
        x = x.toString();
        var lastThree = x.substring(x.length - 3);
        var otherNumbers = x.substring(0, x.length - 3);
        if (otherNumbers != '')
            lastThree = ',' + lastThree;
        return otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree + afterPoint;
}					
</script> 
<script type="text/javascript">
function addarticlerow(){

		if($('#totalrow').attr('value')){
			b2bcountrow = $('#totalrow').attr('value');
		}else{
			b2bcountrow = 0;
		}

		html = '<tr id="article_row' + b2bcountrow + '">';
		html += '<td style="text-align: center;"><input type="checkbox" class="countArticle">';
		html += '<input type="hidden" class="sort_order" name="order_products[' + b2bcountrow + '][sort_order]" value=""></td>';
		html += '<td><input class="form-control" type="text" name="order_products[' + b2bcountrow + '][model]" value="" placeholder="{{column_model}}" id="article_nr' + b2bcountrow + '" data-oc-target="autocomplete-article-nr' + b2bcountrow + '" autocomplete="off">'
		html += '<ul id="autocomplete-article-nr' + b2bcountrow + '" class="dropdown-menu"></ul>';
	    html += '<input type="hidden" name="order_products[' + b2bcountrow + '][product_id]" value="" id="productrow' + b2bcountrow + '"></td>';
		html += '<td><input class="form-control" type="text" name="order_products[' + b2bcountrow + '][name]" value="" placeholder="{{column_title}}" id="productname' + b2bcountrow + '"></td>';
		html +=	'<td><input onkeyup="pricecal();" class="form-control" class="ctrl_quantity" min="1" type="number" name="order_products[' + b2bcountrow + '][quantity]" value="1" placeholder="{{column_qty}}" id="quantity' + b2bcountrow + '"></td>';
		html += '<td id="options' + b2bcountrow + '"><input type="hidden" id="product_option_id' + b2bcountrow + '" value="">';
		html += '<input type="hidden" name="order_products[' + b2bcountrow + '][option][] value=""><span>No options are available.</span>';
		html += '</td>';
		html += '<td> <input class="form-control" type="text" value="" placeholder="{{column_org_price}}" id="oprice' + b2bcountrow + '" name="order_products[' + b2bcountrow + '][oprice]" readonly="readonly"><input type="hidden" id="oprice_v' + b2bcountrow + '" name="order_products[' + b2bcountrow + '][oprice_v]" value=""></td>';
		html += '<td><input class="form-control" onkeyup="pricecal();" type="text" value="" placeholder="{{column_price}}" id="price' + b2bcountrow + '" readonly="readonly"><input type="hidden" id="pprice' + b2bcountrow + '" name="order_products[' + b2bcountrow + '][price]" value="{{order_product.org_price_base}}">';
		html +=	'</td>';
		html += '<td><input onkeyup="pricecal();" class="form-control" type="text" name="order_products[' + b2bcountrow + '][price_discount_percentage]" value="{{order_product.price_discount_percentage}}" placeholder="{{column_percantage}}" id="price_discount_percentage' + b2bcountrow + '" readonly="readonly"></td>';
		html += '<td style="display:none;" id="tax_classes' + b2bcountrow + '">';
		html += '<input type="hidden" name="order_products[' + b2bcountrow + '][tax_class_id]" value=""><input type="hidden" id="total_tax' + b2bcountrow + '" value=""><input type="hidden" id="total_tax_to_prod' + b2bcountrow + '" name="order_products[' + b2bcountrow + '][total_tax_to_prod]" value="">';
		html += '</td>';
		html += '<td><input type="text" class="form-control" name="order_products[' + b2bcountrow + '][total]" value="" placeholder="{{column_total}}" id="total' + b2bcountrow + '" readonly="readonly"></td>';
		html += '<td><i class="fa fa-minus" onclick="$(\'#article_row' + b2bcountrow + '\').remove();checkEmpty();removerow();"></i></td>';
		html += '<td style="text-align: center; cursor:pointer;"><i class="fa fa-plus" onclick="addarticlerow();"></i></td>';
		html += '<td style="text-align: center; cursor:pointer;"><i class="fa fa-copy" onclick="copyarticlerow(' + b2bcountrow + ');"></i></td>';
		html += '<td><i class="fa fa-arrows sorter" data-move></i></td>';
		html += '</tr>';

        $('#article tbody').append(html);
		
		b2bcountrow++;

        $('#totalrow').val(b2bcountrow);


	$("[id^=article_nr]").each(function () {
        $(this).autocomplete({
            'source': function (request, response) {
                $.ajax({
                    url: 'index.php?route=codevoc/b2bmanager_quotation.productsautocomplete&user_token={{ user_token }}&filter_name=' + encodeURIComponent(request),
                    dataType: 'json',
                    success: function (json) {
                        response($.map(json, function (item) {
                            return {
							    label: item['name'],
                                value: item['product_id'],
                                product_name: item['product_name'],
                                model: item['model'],
                            }
                        }));
                    }
                });
            },
            'select': function (item) {
				var res = item['model'];
                $(this).attr('value',res);
				$(this).val(res);
                res1 = item['product_name'];

                var pid = $(this).attr('id');
                var values = pid.split('article_nr');
                var countid = values[1];
                $('#productrow' + countid).val(item['value']);
                $('#productname' + countid).val(res1);
				displayRes(item['value'], this.id);
				calculateArticleTotals();
				addarticlerow();
				//$('input[name=\'order_products['+totalrow+'][product_id]\']' ).attr('value',res3);
            }
        });
    });

	$('#price_discount_percentage' + b2bcountrow).keypress(function (event) {
            return isNumber(event, this)
    });

    $('#price' + b2bcountrow).keypress(function (event) {
        return isNumber(event, this)
    });


    rearrange_rows();
	if($('#article tbody tr').length>0)
	{
		$('#button-addrow').hide();
	}
}



	if($('#article tbody tr').length>0)
	{
		$('#button-addrow').hide();
	}

if($('input[name=\'quotation_id\']').val() == 0){
		addarticlerow();
}
function checkEmpty(){
	if($('#article tbody tr').length==0){
		$('#button-addrow').show();
	}
	pricecal();
}

 function copyarticlerow(row_id) {

		if($('#article_nr'+parseInt(row_id+1)).val()){
			var b2bcountrow = $('#totalrow').val();
		}else{
			var b2bcountrow = $('#totalrow').val();
		}
			var origin_article_row = $("#article_row" + row_id);
			var new_row = $(origin_article_row).clone();
			var tbody = $(origin_article_row).closest('tbody');
			var last_row = $(tbody).find("tr:last");
		


        // Select control select value
        new_row.find("select").each(function (i) {
            this.selectedIndex = origin_article_row.find("select")[i].selectedIndex;
        });

        // replace product id with new id
        $(new_row).attr("id", "article_row" + b2bcountrow);


        // Hidden sort order field
        $(new_row).find("td").eq(0).find('[type="hidden"]').attr("name", 'order_products[' + b2bcountrow + '][sort_order]');

        // Model number column id replace
        $(new_row).find("td").eq(1).find('[type="text"]').attr("name", 'order_products[' + b2bcountrow + '][model]');
        $(new_row).find("td").eq(1).find('[type="text"]').attr("id", 'article_nr' + b2bcountrow);
		$(new_row).find("td").eq(1).find('[type="text"]').attr("data-oc-target", 'autocomplete-article-nr' + b2bcountrow);
		$(new_row).find("td").eq(1).find('ul').attr("id", 'autocomplete-article-nr' + b2bcountrow);
        $(new_row).find("td").eq(1).find('[type="hidden"]').attr("name", 'order_products[' + b2bcountrow + '][product_id]');
        $(new_row).find("td").eq(1).find('[type="hidden"]').attr("id", 'productrow' + b2bcountrow);

        // Product name column id replace
        $(new_row).find("td").eq(2).find('[type="text"]').attr("name", 'order_products[' + b2bcountrow + '][name]');
        $(new_row).find("td").eq(2).find('[type="text"]').attr("id", 'productname' + b2bcountrow);

        // Quantity replace
        $(new_row).find("td").eq(3).find('[type="number"]').attr("name", 'order_products[' + b2bcountrow + '][quantity]');
        $(new_row).find("td").eq(3).find('[type="number"]').attr("id", 'quantity' + b2bcountrow);

        // Options id replace
        if ($(new_row).find("td").eq(4).find('select').length > 0) {
			var counter=0;
            $(new_row).find("td").eq(4).find('select').each(function (i) {
                this.selectedIndex = origin_article_row.find("select")[i].selectedIndex;
                var select_old_name = $(this).attr("name");
                var select_new_name = select_old_name.replace('order_products[' + row_id + ']', 'order_products[' + b2bcountrow + ']');
                $(this).attr("name", select_new_name);

				var select_old_name = $(this).attr("id");
                var select_new_name = select_old_name.replace('optiondropdown' + row_id+'_'+counter, 'optiondropdown' + b2bcountrow+'_'+counter);
                $(this).attr("id", select_new_name);

				var select_old_name = $(this).attr("onChange");
				var select_new_name = select_old_name.replace('oppricecal('+row_id+',' + counter + ');', 'oppricecal('+b2bcountrow+',' + counter + ');');
				$(this).attr('onChange', select_new_name);
				counter=counter+1;


			});

        } else {
            $(new_row).find("td").eq(4).attr('id', 'options' + b2bcountrow);
            $(new_row).find("td").eq(4).find('[type="hidden"]').attr("name", 'order_products[' + b2bcountrow + '][product_option][]');
        }

			//v5
			//for hidden filds
			if ($(new_row).find("td").eq(4).find('select').length > 0) {
					var counter=0;
					$(new_row).find("td").eq(4).find('input').each(function (i) {
					var select_old_name = $(this).attr("id");
					var oldvalue=$(select_old_name).val();
					var select_new_name = select_old_name.replace('optionprice' + row_id+'_'+counter, 'optionprice' + b2bcountrow+'_'+counter);
					$(this).attr("id", select_new_name);
					$(select_new_name).val(oldvalue);
					counter=counter+1;
				});
			}
			//for hidden fields
			//v5

        $(new_row).find("td").eq(4).attr("id", "options" + b2bcountrow);

		//discount price calculation
		 $(new_row).find("td").eq(5).find('[type="text"]').attr("name", 'order_products[' + b2bcountrow + '][oprice]');
       	 $(new_row).find("td").eq(5).find('[type="text"]').attr("id", 'oprice' + b2bcountrow);
		 $(new_row).find("td").eq(5).find('[type="hidden"]').attr("name", 'order_products[' + b2bcountrow + '][oprice_v]');
       	 $(new_row).find("td").eq(5).find('[type="hidden"]').attr("id", 'oprice_v' + b2bcountrow);
		//discount price calculation

        // price id replace

		//v5
		 $(new_row).find("td").eq(6).find('[type="hidden"]').attr("name", 'order_products[' + b2bcountrow + '][price]');
       	 $(new_row).find("td").eq(6).find('[type="hidden"]').attr("id", 'pprice' + b2bcountrow);
		//v5

        $(new_row).find("td").eq(6).find('[type="text"]').attr("id", 'price' + b2bcountrow);

        // price  discount id replace
        $(new_row).find("td").eq(7).find('[type="text"]').attr("name", 'order_products[' + b2bcountrow + '][price_discount_percentage]');
        $(new_row).find("td").eq(7).find('[type="text"]').attr("id", 'price_discount_percentage' + b2bcountrow);


		// Tax Classes id replace
        $(new_row).find("#tax_classes"+row_id).attr("id", "tax_classes" + b2bcountrow)

        $(new_row).find("td").eq(8).find('[name="order_products['+row_id+'][tax_class_id]"]').attr("name", "order_products[" + b2bcountrow + "][tax_class_id]");
		$(new_row).find("#total_tax" + row_id).attr("id", "total_tax" + b2bcountrow);
		$(new_row).find("#total_tax_to_prod" + row_id).attr("id", "total_tax_to_prod" + b2bcountrow);
		$(new_row).find("td").eq(8).find('[name="order_products['+row_id+'][total_tax_to_prod]"]').attr("name", "order_products["+b2bcountrow+"][total_tax_to_prod]");

        // total id replace
        $(new_row).find("#total" + row_id).attr("name", 'order_products[' + b2bcountrow + '][total]');
        $(new_row).find("#total" + row_id).attr("id", 'total' + b2bcountrow);


		 // change action buttons id
        $(new_row).find("td").eq(10).find(".fa-minus").attr("onclick", "$('#article_row" + b2bcountrow + "').remove();pricecal();checkEmpty();");
        $(new_row).find("td").eq(10).find(".fa-minus").attr("data-row-id",b2bcountrow);

        $(new_row).find("td").eq(12).find(".btn-action-copy").attr("onclick", "copyarticlerow(" + b2bcountrow + ")");
		$(new_row).find("td").eq(12).find(".btn-action-copy").attr("data-row-id",b2bcountrow);


        $(origin_article_row).after(new_row);

        // change descriptino row ids


        //for the product
        $("[id^=article_nr]").each(function () {
            $(this).autocomplete({
                'source': function (request, response) {
                    $.ajax({
                        url: 'index.php?route=codevoc/b2bmanager_quotation.productsautocomplete&user_token={{ user_token }}&filter_name=' + encodeURIComponent(request),
                        dataType: 'json',
                        success: function (json) {
                            response($.map(json, function (item) {
                                return {
                                    label: item['name'],
                                    value: item['product_id'],
									product_name: item['product_name'],
                                    model: item['model']
                                }
                            }));
                        }
                    });
                },
                'select': function (item) {
                    var res = item['model'];
                    $(this).val(res);
                    res1 = item['product_name'];
					var pid = $(this).attr('id');
                    var values = pid.split('article_nr');
                    var countid = values[1];
                    $('#productrow' + countid).val(item['value']);
					$('#productname' + countid).val(res1);
					displayRes(item['value'], this.id);
					addarticlerow();
                }
            });
			calculateArticleTotals();
        });

		$('#price_discount_percentage' + b2bcountrow).keypress(function (event) {
            return isNumber(event, this)
        });

        $('#price' + b2bcountrow).keypress(function (event) {
            return isNumber(event, this)
        });

        rearrange_rows();


        //for the product
        b2bcountrow++;

        $('#totalrow').val(b2bcountrow);


        pricecal();

		if($('#article tbody tr').length>0)
		{
			$('#button-addrow').hide();
		}

}
</script>
<script type="text/javascript">
    var calculateArticleTotals;
    $(document).ready(function(){

				// handle check all
				$(".countArticle.selectAll").on('change', function(e) {
					var checked = $(this).is(':checked')
					$('tbody .countArticle').prop('checked', checked)
				});

        // calculate total quantity for articles
        calculateArticleTotals = function(){
            var total_articles = 0;
            var total_articles_quantity = 0;
						var countCheckedItemsOnly = $('.countArticle:checkbox:checked').length > 0
            $("#article tbody tr[id^='article_row']").each(function(){
								var isChecked = $(this).find(".countArticle:checked").length > 0
								if(countCheckedItemsOnly && !isChecked)
									return;
                var row_id = $(this).attr("id");
                var article_nr = row_id.replace("article_row","#article_nr");
                var article_nr = $(article_nr).val();
                if(!article_nr.match("^00-") && article_nr >= 0){
                  var qty_row = $(this).find("td").eq(4);
                  var qty = parseInt($(qty_row).find("[type='number']").val());
									total_articles_quantity += qty;
									++total_articles;
                }
            });
        };

        // calculate on load of page
        calculateArticleTotals();

        // calculate totals on remove article
        $(document).on("click",".btn-action-remove",function() {
            calculateArticleTotals();
        });

        // calculate total on change of quantity
        $(document).on("change",".ctrl_quantity",function() {
            calculateArticleTotals();
        });

				// article checkbox check change event
				$(".countArticle").on('change', function() {
					calculateArticleTotals();
				})

    });
		if($('#input-payment-country').val()){
			$('#payment-details select[name=\'input_payment_country_id\']').trigger('change');
			payment_zone_id = '{{payment_zone_id}}';
		}else if(!($('#payment_address_id').val())){
			payment_zone_id = '';
		}
		if($('#input-payment-country').val()){
			$('#shipping-details select[name=\'input_shipping_country_id\']').trigger('change');
			shipping_zone_id = '{{shipping_zone_id}}';
		}else if(!($('#shipping_address_id').val())){
			shipping_zone_id = '';
		}

function generateCart(custom_cart_url){
  window.prompt("Copy to clipboard: Ctrl+C, Enter", custom_cart_url);
}

function oppricecal(rowcount,counter)
{	var product_option_value_id=$('#optiondropdown'+rowcount+'_'+counter+' option:selected').val();
	var product_id=$('#productrow'+rowcount).val();
	//discount price calculation	
	var customer_id = $("#customer_id").val();
	var quantity = $("#quantity" + rowcount).val();
	//discount price calculation	

					$.ajax({
					url: 'index.php?route=codevoc/b2bmanager_order.getpoprice&user_token={{ user_token }}&product_option_value_id=' + product_option_value_id+'&product_id=' + product_id+'&customer_id=' + customer_id + '&quantity=' + quantity+'&rowcount='+rowcount, //discount price calculation	url update with param
					dataType: 'json',
					type: 'post', //discount price calculation
					success: function(result)
					{
								$('#optionprice'+rowcount+'_'+counter).val(result['success']);
								//discount price calculation	
								if(result['price_discount_percentage']>0)
								{
									var pricediscount_percentage = parseFloat(result['price_discount_percentage']).toFixed(2);
									$('#price_discount_percentage'+rowcount).val(pricediscount_percentage);
								}
								//discount price calculation	
								pricecal();

					},
					error: function(xhr, ajaxOptions, thrownError) {

						alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					}
		});

}

  document.addEventListener('DOMContentLoaded', function () {
    const copyButtons = document.querySelectorAll('.copy-button');

    copyButtons.forEach(function (button) {
      button.addEventListener('click', function () {
        const copyName = button.dataset.copyname;

        // Create a temporary textarea element
        const textarea = document.createElement('textarea');
        textarea.value = copyName; // Set the value to the customer name

        // Append the textarea to the document
        document.body.appendChild(textarea);

        // Copy the content to the clipboard
        textarea.select();
        document.execCommand('copy');

        // Remove the temporary textarea
        document.body.removeChild(textarea);
      });
    });
  });

$('#order_cost').on('click',function(){
	$('#orderCostModal').modal('show');
});

Vue.component('order-detail-costs', {
  data: function() {
    return {
			orderId: "{{ order_id }}",
			costs: JSON.parse('{{ costs | json_encode }}'),
      all_suppliers: JSON.parse('{{ all_suppliers | json_encode }}'),
      supplier: "",
      costs_list: [],
			type: '',
			label: '',
      cost: null,
      error: null,
      success: null,
      processing: false,
    }
  },
  mounted: function() {
    this.costs_list = Array.from(this.costs)
  },
  methods: {
    savePurchaseCost: function(e) {
      var form = this.$refs.form
      if (!form[0].checkValidity()) {
        form[0].reportValidity()
        return;
      }

      if(!this.cost) {
        this.error = "För att spara, ange inköpskostnad .."
        return;
      }

      var self = this
      $.ajax({
        url: 'index.php?route=codevoc/b2bmanager_purchase.savePurchaseCost&user_token={{ user_token }}',
        dataType: 'json',
        method: 'POST',
        data: {
          order_id: this.orderId,
          cost: this.cost,
          supplier: this.supplier,
          type: this.type,
		  label: this.label,
        },
        beforeSend: function() {
          self.error = null
          self.success = null
          self.processing = true
        },
        complete: function() {
          self.processing = false
        },
        success: function(json) {
          if (json['error']) {
            self.error = json['error']
          }

          if (json['success']) {
            self.success = json['success']

            if('item' in json)
              self.costs_list.push(json['item'])

            self.supplier = ''
            self.cost = null
			self.type = ''
			self.label = ''
          }
        },
        error: function(xhr, ajaxOptions, thrownError) {
          alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
      });
      return false;
    },
    removeCost: function(item, index) {
      if(confirm("Are you sure to remove?")) {
        var self = this
        $.ajax({
          url: 'index.php?route=codevoc/b2bmanager_purchase.removeCost&user_token={{ user_token }}',
          dataType: 'json',
          method: 'POST',
          data: {
            cost_id: item.id,
          },
          beforeSend: function() {
            self.error = null
            self.success = null
            self.processing = true
          },
          complete: function() {
            self.processing = false
          },
          success: function(json) {
            if (json['error']) {
              self.error = json['error']
            }

            if (json['success']) {
              self.success = json['success']
            }

            self.costs_list.splice(index,1)
          },
          error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
          }
        });
      }
    },
  },

})

var app = new Vue({
  el: '#vue-order-app',
  delimiters: ['${', '}'],
  data: {
  },
  computed: {
  },
  mounted: function() {
  },
  methods: {
  }
})

</script>
{{ footer }}
