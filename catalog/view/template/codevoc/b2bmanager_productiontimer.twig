<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
    <META NAME="ROBOTS" CONTENT="NOINDEX, FOLLOW">
    <META NAME="ROBOTS" CONTENT="INDEX, NOFOLLOW">
    <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.css">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/easytimer.js@4.5.0/dist/easytimer.min.js"></script>

    <style>
        @import "https://fonts.googleapis.com/css2?family=Space+Mono&display=swap";
        body{background:#131217;color:#adbcdb}
        .productionheader{border-bottom:1px solid #575f70;padding:10px;color:#575f70;margin-bottom:15px}
        .productionheader h5 span{padding:5px;font-size:18px}
        ul.production-list{list-style:none;margin:0;padding:0}
        ul.production-list li{font-size:10px;color:#fff;background-color:#393a42;padding:5px 10px;margin-bottom:1rem;border:0;border-radius:0;}
        ul.production-list li.item-recording{border-left: 10px solid #229c0a;background: #114e11;border-right: 10px solid #229c0a;}
        ul.production-list li .heading .title{background:#282932;border-radius:50px;padding:4px 12px;color:#fff;font-weight:700;margin:9px 9px 0 0}
        ul.production-list li .heading .orderid{border:2px solid #282932;border-radius:50px;padding:4px 12px;color:#eee;font-weight:700;color:#919aad;margin:9px 0 0}
		ul.production-list li .heading .btn-complete {margin: 9px 0 0 9px;background: #0f330c;color: #bbe4be;border: 2px solid #1a7111;padding: 5px 15px;border-radius: 15px;cursor: pointer;									}
        ul.production-list li .badged{padding:2px 5px;border:1px solid #ccc;border-left:5px solid #ccc;border-radius:3px;margin-right:4px;margin-bottom:4px;color:#bfbfbf}
        ul.production-list li .print-method.badged{border-color:#c436b6}
        ul.production-list li .arrival-article.badged,ul.production-list li .arrival-print.badged{border-color:#48c295}
        ul.production-list li .heading{display:inline-block;width:100%}
        ul.production-list li .title{font-size:14px}
        .form-control{margin:9px 0 0;width:79px!important;height:25px;font-size:13px;font-weight:bolder;color:#fff;background-color:transparent;border:1px solid #3a3a3a}
        .input-group-text{margin:9px 0 0;padding:0px 10px;font-size:10px;color:#a3a3a3;background-color:#4c4c4c;border:1px solid #3a3a3a}
        .form-control:disabled,.form-control[readonly]{background-color:transparent;opacity:1;height:27px;border:1px solid #7e7e7e;border-radius:0;text-align:center;font-family:'Space Mono',monospace;font-size:18px}
		.est-time{color: #e2e2e2;font-size: 11px;}
		.est-time b{    border: 1px solid #8e8e8e;padding: 2px 4px;}
		.input-group input[type="text"]{}
        ul.production-list li.item-recording .title{background: #007f00;}
		ul.production-list li.item-recording input[type="text"]{background: #030e03;}
		ul.production-list li.item-recording .minutes {animation: blink-animation 2s steps(5, start) infinite;-webkit-animation: blink-animation 2s steps(5, start) infinite;}
		@keyframes blink-animation {
		to {
			visibility: hidden;
		}
		}
		@-webkit-keyframes blink-animation {
		to {
			visibility: hidden;
		}
		}
		button.start{background:green;border:0;color:#fff;font-size:22px;padding:5px 26px}
        button.stop{background:orange;border:0;color:#fff;font-size:22px;padding:5px 26px}
    </style>
	<script>
		window.token = "{{ token }}"
	</script>

</head>
<body>
<div class="container-fluid">
    <!-- <div class="productionheader">PRODUCTION</div> -->
	<br>
	<div class="holder">
		<div class="row">
			<div class="col-sm" style="margin:0;padding:0;">
				<ul class="production-list">
					<li v-if="productions.length <= 0">No productions found.</li>
					<production
						v-for="(production, key) in productions"
						v-if="production.status != 'Rest'"
						:key="key"
						:production="production"
						inline-template
					>
						<li class="" :class="{'item-recording': isStart}">
							<div class="heading">
							<div class="row">
								<div class="col-sm-6">
									<div class="title float-left">${production.name}</div><div class="float-left orderid">#${production.order_id}</div>
									<button type="button" class="btn-complete" v-if="!isStart" @click="completeProduction"><i class="fa fa-check"></i> Klart</button>
								</div><!--col-->
								<div class="col-sm-2">
									<button class="start" v-if="!isStart" @click="startTimer"><i class="fa fa-play"></i> Start</button>
									<button class="stop" v-if="isStart" @click="stopTimer"><i class="fa fa-stop"></i> Stop</button>
								</div><!--col-->
								<div class="col-sm-4">
									<div class="input-group">
									<div class="input-group-prepend">
										<span class="input-group-text est-time" id="validationTooltipUsernamePrepend"><i class="fa fa-clock"></i> &ensp;Est.&ensp;<b>${production.estimated_duration}m</b></span>
									</div>
									<input type="text" class="form-control" :value="timerValueString" disabled>
									<div class="input-group-prepend">
										<span class="input-group-text minutes" id="validationTooltipUsernamePrepend">M</span>
									</div>
									</div>
								</div><!--col-->
							</div><!--row-->
							</div><!--heading-->
						</li>
					</production>
				</ul>

				<div>
					<h3>Rest Productions</h3>
					<ul class="production-list">
						<li v-if="productions.length <= 0">No productions found.</li>
							<production
								v-for="(production, key) in productions"
								v-if="production.status == 'Rest'"
								:key="key"
								:production="production"
								inline-template
							>
								<li class="" :class="{'item-recording': isStart}">
									<div class="heading">
									<div class="row">
										<div class="col-sm-6">
											<div class="title float-left">${production.name}</div><div class="float-left orderid">#${production.order_id}</div>
											<button type="button" class="btn-complete" v-if="!isStart" @click="completeProduction"><i class="fa fa-check"></i> Klart</button>
										</div><!--col-->
										<div class="col-sm-2">
											<button class="start" v-if="!isStart" @click="startTimer"><i class="fa fa-play"></i> Start</button>
											<button class="stop" v-if="isStart" @click="stopTimer"><i class="fa fa-stop"></i> Stop</button>
										</div><!--col-->
										<div class="col-sm-4">
											<div class="input-group">
											<div class="input-group-prepend">
												<span class="input-group-text est-time" id="validationTooltipUsernamePrepend"><i class="fa fa-clock"></i> &ensp;Est.&ensp;<b>${production.estimated_duration}m</b></span>
											</div>
											<input type="text" class="form-control" :value="timerValueString" disabled>
											<div class="input-group-prepend">
												<span class="input-group-text minutes" id="validationTooltipUsernamePrepend">M</span>
											</div>
											</div>
										</div><!--col-->
									</div><!--row-->
									</div><!--heading-->
								</li>
							</production>
					</ul>
				</div>

			</div><!--col-sm-->
		</div><!--row-->
	</div><!-- holder -->
</div><!--container-fluid-->
<script>
	window.EventBus = new Vue();
	Vue.component('production', {
		props: ['production'],
		data: function() {
			return {
				isStart: false,
				timer: new easytimer.Timer({ startValues: { minutes: parseInt(this.production.worked_duration / 60) } }),
				timerValues: {
					minutes: 0,
					seconds: 0
				},
			}
		},
		computed: {
			timerValueString: function() {
				var minutes = this.timerValues.minutes.toString().padStart(2, '0')
				// var seconds = this.timerValues.seconds.toString().padStart(2, '0')
				return `${minutes}`
				// return `${minutes}:${seconds}`
			}
		},
		mounted: function() {
			var self = this
			this.timerValues = this.timer.getTotalTimeValues()
			this.timer.addEventListener("secondsUpdated", function (e) {
				self.timerValues = self.timer.getTotalTimeValues()
			});
		},
		methods: {
			startTimer: function() {
				this.timer.start()
				this.isStart = true
			},
			stopTimer: function() {
				this.timer.pause()
				this.isStart = false
				this.saveTime()
			},
			saveTime: function() {
				var self = this
				$.ajax({
					url: '{{ catalog }}index.php?route=codevoc/b2bmanager_productiontimer.saveTime&token='+ window.token,
					dataType: 'json',
					method: 'POST',
					data: {
						production_id: self.production.production_id,
						seconds: self.timer.getTotalTimeValues().seconds
					},
					beforeSend: function() {
						// self.error = null
						// self.processing = true
					},
					complete: function() {
						// self.processing = false
					},
					success: function(json) {
						if (json['success']) {
							// self.productions = json['productions']
						}
					},
					error: function(xhr, ajaxOptions, thrownError) {
						alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					}
				});
			},
			completeProduction: function() {
				if(!confirm("Vill du märka produktion som avklarad? KOM IHÅG! ****Ta bilder på produktionen innan packning!"))
					return
				var self = this
				$.ajax({
					url: '{{ catalog }}index.php?route=codevoc/b2bmanager_productiontimer.completeProduction&token='+ window.token,
					dataType: 'json',
					method: 'POST',
					data: {
						production_id: self.production.production_id,
						name: self.production.name,
					},
					beforeSend: function() {
						// self.error = null
						// self.processing = true
					},
					complete: function() {
						// self.processing = false
					},
					success: function(json) {
						if (json['success']) {
							window.EventBus.$emit('production-completed', self.production)
							// self.productions = json['productions']
						}
					},
					error: function(xhr, ajaxOptions, thrownError) {
						alert("2");
						alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					}
				});
			}
		},
	})
	var app = new Vue({
		el: '.container-fluid',
		delimiters: ['${', '}'],
		data: {
			productions: [],
			error: null,
			processing: false,
		},
		created: function() {
			this.getProductions()
		},
		mounted: function() {
			var self = this
			window.EventBus.$on('production-completed', function(production) {
				self.productions = self.productions.filter(function(x) {
					return x.production_id != production.production_id
				})
			})
		},
		methods: {
			getProductions: function() {
				var self = this
				$.ajax({
					url: '{{ catalog }}index.php?route=codevoc/b2bmanager_productiontimer.getProductions&token='+ window.token,
					dataType: 'json',
					method: 'GET',
					data: {},
					beforeSend: function() {
						self.error = null
						self.processing = true
					},
					complete: function() {
						self.processing = false
					},
					success: function(json) {
						if (json['error']) {
							self.error = json['error']
						}

						if (json['productions']) {
							self.productions = json['productions']
						}
					},
					error: function(xhr, ajaxOptions, thrownError) {
						alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					}
				});
			},
		}
	})
</script>

</body>
</html>